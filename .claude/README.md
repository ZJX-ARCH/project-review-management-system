# 🚀 自主协作工作流系统 V4.0

> **V4.0强化版** - 单一配置 + 林纳斯哲学 + SuperClaude + 迭代对抗 + 防遗漏 + 渐进休眠 + 强制记录

---

## 🎯 V4.0 核心改进

### ✅ 已解决的V3痛点（7/7）

| 痛点 | V2.0/V3.1 | V4.0 解决方案 |
|------|-----------|--------------|
| **中途停止** | ❌ Agent执行超时 | ✅ 渐进式休眠（5分钟→10秒→30秒→1分钟） |
| **忘记Git提交** | ⚠️ 堆积多个功能 | ✅ 测试通过立即提交，禁止堆积 |
| **并行执行混乱** | ⚠️ 状态不一致 | ✅ 强制串行执行，一个一个完成 |
| **忘记更新记录** | ⚠️ 进度丢失 | ✅ 4层记忆系统 + 强制更新 |
| **Agent忘记交接** | ⚠️ 上下文缺失 | ✅ 每次调用必须准备交接文档 |
| **重启后遗忘** | ❌ 无法恢复 | ✅ QUICK_RESUME.md 30秒快速恢复 |
| **功能遗漏** | ⚠️ 设计不完整 | ✅ 迭代对抗设计（多轮循环直到无大错误） |

---

## 📁 V4.0 文件结构

```
v4.0/
├── workflow.json                       # ⭐ 主配置文件（1324行）
├── persona-mapping.json                # SuperClaude角色映射
├── superclaude-integration.json        # SuperClaude集成配置
├── settings.local.json                 # 本地设置
├── README.md                           # 本文档
├── ARCHITECTURE.md                     # 系统架构文档
├── IMPLEMENTATION_GUIDE.md             # 实施指南
│
├── docs/                               # 项目文档目录
│   ├── project/                        # 项目级文档
│   │   └── master-plan.md             # 项目主计划
│   └── progress/                       # 进度追踪
│       ├── QUICK_RESUME.md            # ⭐ 30秒快速恢复
│       ├── PROJECT_CONTEXT.md         # 项目上下文
│       ├── MODULE_CONTEXT.md          # 模块上下文
│       └── HISTORY.md                 # 任务历史
│
├── guides/                             # 操作指南
│   ├── ANTI_FORGET_CHECKLIST.md       # 防遗漏检查清单
│   ├── ENCODING_GUIDE.md              # 编码指南（解决中文乱码）
│   └── MEMORY_GUIDE.md                # 记忆系统使用指南
│
└── templates/                          # 文档模板
    ├── module/                         # 模块级模板
    │   ├── 00-requirement.md          # 需求模板
    │   ├── 01-design-dual-column.md   # 双栏设计模板
    │   ├── 02-tasks.md                # 任务清单模板
    │   └── ...
    └── checkpoint/                     # 检查点模板
        ├── submodule-checkpoint.md
        └── module-checkpoint.md
```

---

## ⚡ 快速开始

### 1. 初始化新项目

```bash
# 进入你的项目目录
cd D:\MyProject

# TODO: 创建初始化脚本
# C:\Users\lenovo\.claude\workflows\v4.0\scripts\init-project.bat
```

### 2. 启动第一个任务

在 Claude Code 中：

```
@claude

请使用 V4.0 工作流系统完成以下任务：

【项目】：用户管理系统

【核心功能】：
1. 用户认证模块（Auth）
   - 注册、登录、记住我、忘记密码、邮箱验证

2. 用户资料模块（Profile）
   - 查看资料、编辑资料、头像上传

【技术栈】：
- 前端：React + Ant Design
- 后端：Spring Boot + MyBatis-Plus
- 数据库：MySQL 8.0

请自主完成，我会在 QUICK_RESUME.md 查看进度。
```

### 3. 中途需要关闭电脑？

**重启后恢复**：

```
@claude

【恢复上次工作】

请读取 docs/progress/QUICK_RESUME.md 并继续完成。
```

---

## 🌟 V4.0 核心特性详解

### 1️⃣ 渐进式休眠机制

**问题**：V2.0/V3.1中Agent执行超时导致中途停止

**解决**：在所有长任务Agent的prompt中自动注入休眠指令

```
⚠️ 重要：请在执行过程中渐进式休眠防止超时：
- 第1次工作5分钟后休眠10秒
- 第2次工作5分钟后休眠30秒
- 第3次及以后每工作5分钟休眠1分钟
```

**应用阶段**：P0、阶段1、阶段4等关键阶段

---

### 2️⃣ 迭代对抗设计（阶段1）

**问题**：V2.0设计阶段容易遗漏功能（如Auth模块忘记"记住我"、"忘记密码"），一次性修正不够充分

**解决**：迭代对抗机制（多轮循环直到无大错误）

```
Designer (Gemini) → 起草完整设计（前后端）v1
   ↓
[迭代循环开始 - 最多5轮]
   ↓
Critic (Codex) → 红队攻击，找出所有漏洞和遗漏（第N轮）
   ↓
主控检查：Critical和High问题数为0？
   ├─ YES → 退出循环，进入Architect终审
   └─ NO  → Designer修正 → Critic重新审查（第N+1轮）

[迭代循环结束：无Critical/High问题 OR 达到5轮]
   ↓
Architect (Opus) → 终审批准或驳回
```

**循环退出条件**：
- ✅ **理想退出**：Critic报告Critical=0 AND High=0
- 🚫 **强制退出**：达到最大迭代次数（5轮）
- ✅ **Architect决策**：即使有少量Medium/Low问题也可批准

**检查内容**：
- ✅ 功能遗漏检查（每轮）
- ✅ 前后端对应检查（每轮）
- ✅ 安全漏洞检查（每轮）
- ✅ 边缘案例检查（每轮）
- ✅ 上一轮修正质量评价（第2轮起）

---

### 3️⃣ 4层记忆系统

**问题**：V2.0/V3.1重启后遗忘，需要大量时间恢复上下文

**解决**：分层记忆架构

```
L0: QUICK_RESUME.md（30秒快速恢复）
├─ 最近3次操作
├─ 当前层级和步骤
├─ 一句话恢复指令
└─ 关键上下文（500字以内）

L1: PROJECT_CONTEXT.md（项目级）
├─ 项目整体架构
├─ 已完成模块列表
└─ 待完成模块列表

L2: MODULE_CONTEXT.md（模块级）
├─ 模块设计文档链接
├─ 前后端实现状态
└─ 遗留问题

L3: HISTORY.md（任务历史）
└─ 所有已完成任务的时间线
```

**恢复流程**：
1. 先读L0（30秒恢复80%上下文）
2. 需要更多上下文再读L1、L2、L3

---

### 4️⃣ 强制串行执行

**问题**：V2.0/V3.1并行执行导致状态混乱、遗漏检查

**解决**：主控强制串行执行流程

```python
# V4强制执行流程
while 还有任务:
    1. 选择当前要执行的任务（只能1个）
    2. 调用Agent执行该任务
    3. 等待Agent返回结果
    4. 主控验证输出（检查文件是否生成、内容是否正确）
    5. 更新记忆文件（QUICK_RESUME + HISTORY）
    6. 如果测试通过，立即Git提交
    7. 选择下一个任务
```

**禁止行为**：
- ❌ 不允许同时调用多个Agent
- ❌ 不允许批量提交多个任务的Git
- ❌ 不允许跳过Agent返回结果的验证

---

### 5️⃣ 立即Git提交

**问题**：V2.0容易忘记Git提交，或堆积多个功能后一起提交

**解决**：阶段8强制规则

```
✅ 测试通过（阶段7）→ 立即进入阶段8（Git提交）
❌ 不允许完成多个功能后再一起提交
✅ 每个任务单独提交一次
✅ 自动更新 HISTORY.md（任务ID + Commit Hash）
```

**好处**：
- 防止丢失工作成果
- 便于回滚
- 保持Git历史清晰

---

### 6️⃣ P0用户审查

**问题**：V2.0架构设计后直接执行，用户无法审查

**解决**：阶段P0增加强制用户审查步骤

```
1. Opus完成架构设计（master-plan.md）
2. 主控输出消息：
   "📋 项目架构设计已完成，请查看 docs/project/master-plan.md"
   "⚠️ 请确认架构设计是否符合预期。确认后输入\"继续\"，如需修改请说明。"
3. 等待用户输入（必须等待，不能自动继续）
4. 用户确认后，进入阶段0
```

---

### 7️⃣ 强制交接文档

**问题**：V2.0/V3.1 Agent执行时缺少完整上下文

**解决**：每次调用Agent必须准备交接文档

**交接文档模板**：

```markdown
## ⚠️ 重要执行指令
[渐进式休眠指令...]

## 任务背景
[上下文、需求、目标...]

## 任务要求
[具体做什么...]

## 约束条件
[不能做什么、必须遵守什么...]

## 验收标准
[如何验证完成...]

## 相关文件
[需要读取/修改的文件...]
```

---

## 🎨 SuperClaude 集成

V4.0深度集成SuperClaude命令系统，提供31个专业化命令。

### 常用命令示例

| 阶段 | 命令 | 说明 |
|------|------|------|
| P0 | `/sc:design --architecture` | 架构设计 |
| 1.步骤1 | `/sc:design --api --ddd` | Designer起草设计 |
| 1.步骤2 | `/sc:improve --quality OR /sc:reflect` | Critic红队攻击 |
| 4前端 | `/sc:build --react --magic` | 前端实现 |
| 4后端 | `/sc:build --api --tdd` | 后端实现 |
| 5 | `/sc:improve --quality` | 代码审查 |
| 7 | `/sc:test --coverage` | 测试验证 |
| 8 | `/sc:git` | Git提交 |

---

## 📊 模型选择策略

V4.0更新了所有模型到最新版本：

| 模型 | 版本 | 使用场景 |
|------|------|---------|
| **Opus** | claude-4.5-opus | P0架构设计、阶段1终审、复杂决策 |
| **Gemini** | gemini-3.0-pro | 阶段1 Designer、前端实现、超长上下文 |
| **Sonnet** | claude-4.5-sonnet | 主控决策、常规任务、代码审查 |
| **Haiku** | claude-4.5-haiku | 阶段8 Git提交、简单机械任务 |
| **Codex** | gpt-5.1-codex | 阶段1 Critic、后端实现、代码审查 |

---

## 📖 完整文档索引

| 文档 | 路径 | 用途 |
|------|------|------|
| **主配置** | workflow.json | 核心工作流配置 |
| **架构设计** | ARCHITECTURE.md | 理解系统设计 |
| **实施指南** | IMPLEMENTATION_GUIDE.md | 详细使用说明 |
| **编码指南** | guides/ENCODING_GUIDE.md | 解决中文乱码 |
| **记忆指南** | guides/MEMORY_GUIDE.md | 记忆系统使用 |
| **防遗忘清单** | guides/ANTI_FORGET_CHECKLIST.md | 功能遗漏检查 |

---

## 🎯 设计理念

V4.0深度贯彻林纳斯·托瓦兹的工程哲学：

| 原则 | V4.0 的应用 |
|------|-----------|
| **简洁性高于一切** | ✅ 单一workflow.json配置<br>✅ 流程自动化<br>✅ 记忆系统分层清晰 |
| **拒绝过度设计** | ✅ 每个复杂机制都是为了解决真实痛点<br>✅ 三方对抗检查过度设计 |
| **向后兼容** | ✅ 可以从 V2.0 平滑迁移<br>✅ 保留所有 V2.0 的优点 |
| **代码质量不容妥协** | ✅ 三方对抗设计<br>✅ 强制串行执行<br>✅ 立即Git提交 |

---

## 🚦 下一步

### 1. 阅读实施指南
📖 [IMPLEMENTATION_GUIDE.md](./IMPLEMENTATION_GUIDE.md)

### 2. 理解系统架构
📖 [ARCHITECTURE.md](./ARCHITECTURE.md)

### 3. 开始第一个项目
参考上面的"快速开始"部分

---

## 📞 版本信息

- **版本**: 4.0
- **状态**: ✅ 配置完成，等待实际项目验证
- **设计者**: Claude Code (Sonnet 4.5)
- **设计时间**: 2025-11-30
- **基于**: V2.0（1058行）扩展到 V4.0（1324行）

---

## 📝 版本历史

### V4.0 (2025-11-30)
- ✅ 添加渐进式休眠机制
- ✅ 添加三方对抗设计流程
- ✅ 添加4层记忆系统
- ✅ 强制串行执行
- ✅ 立即Git提交机制
- ✅ P0用户审查
- ✅ 强制交接文档
- ✅ 更新所有模型版本

### V2.0 (2025-11-17)
- ✅ 单一配置文件
- ✅ 9阶段完整流程
- ✅ 模型选择策略
- ✅ SuperClaude集成

---

**🎉 V4.0已就绪，开始您的自主开发之旅！**
