# 用户定版机制（User-Defined Module Specification）

> **版本**：V4.0
> **目的**：让用户在需求阶段定义模块子功能清单，后续系统自动检查

---

## 📋 机制概述

**核心思想**：用户在需求阶段定义模块的子功能清单 → 系统自动保存 → 后续所有检查都基于定版清单

**一次定版，全程自动**

---

## 🔄 V4.0 完整流程

### 阶段1：需求分析 - 用户定版

#### Designer 分析需求

```
Designer: 我分析了你的需求，识别出以下模块和子功能：

【模块1：Auth 模块】
建议的子功能清单：
1. 用户注册
2. 用户登录
3. 用户登出
4. 记住我功能
5. 忘记密码
6. 重置密码
7. 邮箱验证

请确认：
✅ 我确认以上清单完整
⚠️ 我需要添加：[请填写]
⚠️ 我需要删除：[请填写]
```

#### 用户确认并定版

**选择A：直接确认**
```
✅ 确认，就按这7个子功能来
```

**选择B：添加子功能**
```
⚠️ 我需要添加：
8. 第三方登录（Google、GitHub）
9. 手机号验证
```

---

### 阶段2：三方对抗设计 - 自动对照检查

#### Designer 设计时自动检查

在 `01-design-draft.md` 中：

```markdown
## 子功能设计覆盖检查

基于用户定版清单（00-requirement.md）：
- [x] 1. 用户注册 - 已设计
- [x] 2. 用户登录 - 已设计
- [x] 3. 用户登出 - 已设计
- [x] 4. 记住我功能 - 已设计
- [x] 5. 忘记密码 - 已设计
- [x] 6. 重置密码 - 已设计
- [x] 7. 邮箱验证 - 已设计
- [x] 8. 第三方登录 - 已设计
- [x] 9. 手机号验证 - 已设计

✅ 覆盖率：9/9（100%）
```

#### Critic 审查时自动检查

在 `01-critique.md` 中：

```markdown
## 完整性审查 - 基于用户定版清单

| 定版子功能 | 前端设计 | 后端设计 | 状态 |
|-----------|---------|---------|------|
| 1. 用户注册 | ✅ | ✅ | ✅ PASS |
| 2. 用户登录 | ✅ | ✅ | ✅ PASS |
| 3. 用户登出 | ✅ | ✅ | ✅ PASS |
| 4. 记住我功能 | ✅ | ✅ | ✅ PASS |
| 5. 忘记密码 | ✅ | ✅ | ✅ PASS |
| 6. 重置密码 | ✅ | ✅ | ✅ PASS |
| 7. 邮箱验证 | ✅ | ✅ | ✅ PASS |
| 8. 第三方登录 | ✅ | ❌ | ❌ FAIL |
| 9. 手机号验证 | ✅ | ✅ | ✅ PASS |

**覆盖率**：8/9（88.9%）

### 🚨 Critical Issues
**Issue #1**：第三方登录缺少后端设计
```

---

### 阶段3：任务拆分 - 自动生成任务清单

在 `02-tasks.md` 中：

```markdown
## 基于用户定版清单的任务拆分

**定版清单**：9个子功能

### 子模块1：用户注册
- T1.1：实现注册Entity
- T1.2：实现注册Service
- ...

### 子模块8：第三方登录（用户添加）
- T8.1：设计OAuth2集成方案
- T8.2：实现Google登录后端
- ...

**总任务数**：63个
**预估总时间**：15小时
```

---

### 阶段4：实施阶段 - 自动检查点验证

在 `module-checkpoint.md` 中：

```markdown
## 基于用户定版清单的完整性验证

**定版清单来源**：00-requirement.md
**定版子功能数**：9个

| # | 子功能 | 前端 | 后端 | 测试 | 状态 |
|---|--------|------|------|------|------|
| 1 | 用户注册 | ✅ | ✅ | ✅ | ✅ 完成 |
| 2 | 用户登录 | ✅ | ✅ | ✅ | ✅ 完成 |
| ... | ... | ... | ... | ... | ... |
| 9 | 手机号验证 | ✅ | ✅ | ✅ | ✅ 完成 |

**完成度**：9/9（100%）
```

---

### 阶段5：4层记忆 - 自动提醒

在 `QUICK_RESUME.md` 中：

```markdown
## 当前状态
- 模块：Auth 模块
- 进度：2/9 完成

## 重要提醒
⚠️ **基于用户定版清单（00-requirement.md）**：
- Auth模块共9个子功能（用户定版）
- 已完成：2个
- 剩余：7个

**剩余子功能清单**：
3. ❌ 用户登出
4. ❌ 记住我功能
5. ❌ 忘记密码
...

🔴 不要遗漏任何子功能！
```

---

## 🎯 V4.0 特性

### 用户体验

**用户只需操作1次**（在需求阶段）：
```
Designer: 我建议Auth模块包含7个子功能...
用户: ✅ 确认，再加上"第三方登录"和"手机号验证"
Designer: 好的，已定版为9个子功能，后续自动检查。
```

### 后续全自动

- ✅ 三方对抗设计：自动检查是否覆盖所有定版子功能
- ✅ 任务拆分：自动生成所有子功能的任务
- ✅ 检查点：自动验证所有定版子功能是否完成
- ✅ 4层记忆：自动提醒剩余子功能

---

## 🔧 技术实现

### 定版清单的数据结构

在 `00-requirement.md` 中：

```json
<!-- MODULE_SPEC_START: Auth -->
{
  "module_name": "Auth",
  "locked_at": "2025-11-30T10:30:00Z",
  "locked_by": "user + Designer",
  "submodules": [
    {
      "id": 1,
      "name": "用户注册",
      "name_en": "Register",
      "required": true,
      "added_by": "Designer"
    },
    {
      "id": 8,
      "name": "第三方登录",
      "name_en": "Third-party Login",
      "required": true,
      "added_by": "user"
    }
  ],
  "total_count": 9
}
<!-- MODULE_SPEC_END -->
```

---

## 🎉 总结

### 核心优势

1. ✅ **一次定版，全程自动**
2. ✅ **灵活可调**（支持添加/删除）
3. ✅ **动态检查**（基于定版清单）
4. ✅ **防止遗漏**（4层记忆提醒）
5. ✅ **V4.0集成**（三方对抗设计）

---

**用户定版机制 = 一次定版 + 全程自动 + 防止遗漏！**
