# 编码容错机制（Encoding Fault Tolerance）

> **版本**：V4.0
> **目的**：防止中文乱码问题导致流程卡死，浪费 token

---

## 🚨 核心问题

**问题**：Codex 可能无法正确处理中文字符，反复尝试修复会浪费大量 token

**V4.0解决方案**：三级容错机制

---

## ✅ 三级容错机制

### Level 1: 检测机制

**触发条件**：连续 **3 次**无法通过中文测试

**检测方法**：在 `01-critique.md` 中记录重试次数

| Attempt | Result | Action |
|---------|--------|--------|
| 1       | FAIL   | Retry  |
| 2       | FAIL   | Retry  |
| 3       | FAIL   | **Switch Strategy** |

---

### Level 2: 策略切换

**第 3 次失败后，自动切换策略**：

#### 策略 A：降级到英文注释
- 移除所有中文注释 → 改为英文
- 用户界面中文保留（存储在配置文件）
- 优点：完全避免中文乱码
- 缺点：代码可读性略降

#### 策略 B：切换到 Gemini 处理中文部分
- Codex 负责纯逻辑代码（无中文）
- Gemini 负责前端 UI、注释、文档（含中文）
- 优点：Gemini 处理中文无问题

#### 策略 C：跳过中文测试（有条件）
- 条件：项目主要用户是英文用户
- 标记为 [SKIP_CHINESE_TEST]
- 优点：不阻塞流程，节省 token

---

### Level 3: 用户决策

**当策略切换失败时，请求用户决策（P0 User Review）**

---

## 🎯 V4.0 特性

- ✅ 集成4层记忆系统（记录重试状态）
- ✅ 渐进式休眠（不会超时）
- ✅ P0用户审核（最终决策）

---

**容错机制完成，防止 token 浪费！**
