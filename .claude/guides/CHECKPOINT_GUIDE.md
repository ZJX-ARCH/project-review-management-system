# 检查点系统使用指南（Checkpoint System Guide）

> **版本**：V4.0
> **更新时间**：2025-11-30
> **适用角色**：所有 Agents、用户

---

## 📋 概述

### 什么是检查点系统？
检查点系统是 V4.0 的 **强制验证机制**，确保：
1. 所有子模块/模块完成后进行全面检查
2. 功能完整性（无遗漏）
3. 测试通过（包含中文测试）
4. 编码规范符合要求
5. **不通过检查点，不能进入下一个模块**

### V4.0 的改进
**相比 V3.1**：
- ✅ 集成三方对抗设计（Designer → Critic → Architect）
- ✅ 集成4层记忆系统（30秒恢复）
- ✅ 渐进式休眠机制（避免超时）
- ✅ 强制串行执行（避免状态混乱）
- ✅ 立即Git提交（避免遗忘提交）

---

## 🏗️ 检查点层次

### 2层检查点架构

```
┌─────────────────────────────────────────┐
│ L1: 子模块检查点 (Submodule Checkpoint)  │  ← 快速检查
│ - 前后端实现完整性                        │
│ - 测试通过（包含中文测试）                 │
│ - 编码规范                               │
│ - Git已提交                              │
├─────────────────────────────────────────┤
│ L2: 模块检查点 (Module Checkpoint)       │  ← 全面检查
│ - 所有子模块完成                          │
│ - 完整测试套件                           │
│ - 编码验证脚本                           │
│ - 安全检查                               │
│ - 文档完整性                             │
│ - 三方对抗设计完成                        │
└─────────────────────────────────────────┘
```

---

## ✅ L1: 子模块检查点

### 用途
在每个子模块完成后，快速检查前后端实现和测试。

### 模板位置
```
templates/checkpoint/submodule-checkpoint.md
```

### 检查项

#### 1. 实现完成度检查
- [ ] **前端实现**：所有组件、页面已实现
- [ ] **后端实现**：Entity、Repository、Service、Controller 已实现
- [ ] **数据库实现**：表已创建，字符集正确（utf8mb4）

#### 2. 测试检查
- [ ] **后端测试**：单元测试通过（Exit Code 0）
- [ ] **前端测试**：组件测试通过（Exit Code 0）
- [ ] **中文测试**：至少 1 个中文测试用例通过
- [ ] **集成测试**：前后端联调成功

#### 3. 编码规范检查
- [ ] **文件编码**：所有文件 UTF-8 编码
- [ ] **数据库编码**：表使用 utf8mb4
- [ ] **API 响应头**：包含 charset=UTF-8

#### 4. Git提交检查（V4.0新增）
- [ ] **立即提交**：测试通过后立即提交
- [ ] **提交消息规范**：符合V4.0规范
- [ ] **提交内容**：只包含本子模块的变更

### 检查点决策
- ✅ **PASS**：所有检查通过，进入下一个子模块
- ❌ **FAIL**：存在问题，必须修复

---

## ✅ L2: 模块检查点

### 用途
在整个模块完成后，全面检查所有子模块、测试、安全、文档。

### 模板位置
```
templates/checkpoint/module-checkpoint.md
```

### 检查项

#### 1. 三方对抗设计检查（V4.0新增）
- [ ] **Designer起草**：01-design-draft.md 完成
- [ ] **Critic攻击**：01-critique.md 完成，发现问题全部修复
- [ ] **Architect终审**：01-architect-verdict.md 批准
- [ ] **Critical/High问题**：0个

#### 2. 子模块完成度检查
所有子模块必须：
- [ ] 前端 ✅ 完成
- [ ] 后端 ✅ 完成
- [ ] 测试 ✅ 通过
- [ ] Git ✅ 已提交

#### 3. 测试检查
- [ ] **后端测试**：所有测试通过（Exit Code 0）
  - 测试覆盖率 ≥ 80%
- [ ] **前端测试**：所有测试通过（Exit Code 0）
  - 测试覆盖率 ≥ 70%
- [ ] **中文测试**：至少 3 个中文测试用例
- [ ] **集成测试**：所有接口调用成功

#### 4. 编码规范检查（强制）
- [ ] **运行编码验证脚本**：`scripts/validate-encoding.bat`
  - Exit Code 0
- [ ] **数据库编码**：所有表使用 utf8mb4
- [ ] **连接字符串**：包含 characterEncoding=utf8mb4
- [ ] **API 响应头**：所有 API 包含 charset=UTF-8

#### 5. 4层记忆检查（V4.0新增）
- [ ] **QUICK_RESUME.md**：已更新（L0）
- [ ] **PROJECT_CONTEXT.md**：已更新（L1）
- [ ] **MODULE_CONTEXT.md**：已更新（L2）
- [ ] **HISTORY.md**：已记录（L3）

#### 6. Git提交检查（V4.0新增）
- [ ] **提交规范**：所有提交符合V4.0规范
- [ ] **提交频率**：每功能测试后立即提交
- [ ] **提交完整性**：所有代码已提交

### 检查点决策矩阵

| 检查项 | 权重 | 得分 | 加权得分 |
|--------|------|------|---------|
| 三方对抗设计 | 20% | [X/10] | [X] |
| 子模块完成度 | 25% | [X/10] | [X] |
| 测试通过率 | 25% | [X/10] | [X] |
| 编码规范 | 15% | [X/10] | [X] |
| 记忆系统 | 10% | [X/10] | [X] |
| Git提交 | 5% | [X/10] | [X] |

**总分**：[X / 10]

### 检查点决策
- ✅ **PASS**：总分 ≥ 8.0，无 Critical Issues
- ⚠️ **PASS WITH MINOR ISSUES**：总分 ≥ 7.0，无 Critical Issues
- ❌ **FAIL**：总分 < 7.0，或存在 Critical Issues

---

## 🔄 检查点执行流程

### 子模块检查点流程
```
子模块实现完成
    ↓
运行测试（Exit Code 0）
    ↓
立即Git提交（V4.0强制）
    ↓
Sonnet 执行 submodule-checkpoint.md
    ↓
检查：实现、测试、编码、Git
    ↓
决策：PASS / FAIL
    ↓
PASS → 更新4层记忆 → 进入下一个子模块
FAIL → 修复问题 → 重新检查
```

### 模块检查点流程
```
所有子模块完成
    ↓
检查三方对抗设计（V4.0）
    ↓
Sonnet 执行 module-checkpoint.md
    ↓
检查：设计、子模块、测试、编码、记忆、Git
    ↓
决策：PASS / PASS WITH MINOR ISSUES / FAIL
    ↓
PASS → 更新4层记忆 → 进入下一个模块
PASS WITH MINOR ISSUES → 记录到 Backlog → 进入下一个模块
FAIL → 修复 Critical Issues → 重新检查
```

---

## 🚨 检查点失败处理

### FAIL 原因分类

#### 1. 三方对抗设计问题（V4.0）
**症状**：Critical/High 问题未全部修复

**处理**：
1. 重新审查 Critic 的问题列表
2. 逐个修复未解决的问题
3. 重新提交 Architect 审核

#### 2. Git提交问题（V4.0）
**症状**：测试通过但未及时提交

**处理**：
1. 立即提交当前代码
2. 补充提交消息（说明原因）
3. 更新 HISTORY.md

#### 3. 记忆系统未更新（V4.0）
**症状**：QUICK_RESUME.md 或其他记忆文件过时

**处理**：
1. 立即更新4层记忆
2. 确保30秒可恢复
3. 重新运行检查点

---

## 📊 检查点与V4.0特性的配合

### 与渐进式休眠的配合
- 检查点执行前：发送休眠信号（避免超时）
- 检查点执行中：每检查一项发送休眠信号
- 检查点完成后：恢复正常工作

### 与三方对抗设计的配合
- Designer 设计 → Critic 发现问题 → Architect 终审 → 检查点验证全部完成

### 与4层记忆的配合
- 检查点完成 → 立即更新4层记忆
- QUICK_RESUME.md 包含检查点结果

### 与立即Git提交的配合
- 测试通过 → 立即提交 → 检查点验证提交完成

---

## 📝 最佳实践

### 1. 及时执行检查点
- 完成子模块后立即执行子模块检查点
- 不要等到所有子模块都完成再检查

### 2. 严格执行，不跳过
- 即使确信没问题，也要执行检查点
- 检查点可能发现意想不到的问题

### 3. 与V4.0特性配合
- 检查点前先确认三方对抗设计完成
- 检查点前先确认Git已提交
- 检查点后立即更新记忆

### 4. FAIL 后立即修复
- 不要累积问题
- 一次只修复一个问题，逐个验证

---

## 🚨 常见问题（FAQ）

### Q1: V4.0 的检查点和 V3.1 有什么区别？
**A**: V4.0 新增：
- 三方对抗设计检查
- 4层记忆系统检查
- Git提交规范检查
- 渐进式休眠支持

### Q2: 检查点太耗时，可以跳过吗？
**A**: 不可以。V4.0 的检查点是必须的，但通过渐进式休眠机制，不会导致超时。

### Q3: 如果检查点FAIL，是否会丢失上下文？
**A**: 不会。V4.0 的4层记忆系统确保：
- QUICK_RESUME.md 实时更新
- 30秒内可恢复
- FAIL 状态也会被记录

---

## 🎯 总结

### 检查点系统的价值（V4.0）
- ✅ **防止遗漏** + 三方对抗设计
- ✅ **确保质量** + 立即Git提交
- ✅ **强制验证** + 4层记忆
- ✅ **不会超时** + 渐进式休眠

### 核心要点
1. **不通过检查点，不能进入下一个模块**
2. **三方对抗 + 检查点 + 记忆系统** = 四重防护
3. **FAIL 后立即修复，不累积问题**
4. **严格执行，不跳过**

---

**使用检查点系统，确保每个模块都完整、正确、高质量！**
