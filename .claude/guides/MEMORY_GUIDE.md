# 记忆系统使用指南

> **V4.0核心特性** - 4层记忆系统详解

---

## 系统概述

### V4.0记忆架构

```
┌─────────────────────────────────────────────────┐
│ L0: QUICK_RESUME.md (最高优先级)                │
│  - 更新频率：每5-10分钟                          │
│  - 大小：500字以内                               │
│  - 内容：最近3次操作 + 当前状态 + 恢复指令       │
│  - 目的：30秒恢复80%上下文                       │
│  - 📱 手机查看：实时了解进度                     │
└─────────────────────────────────────────────────┘
         ▼
┌─────────────────────────────────────────────────┐
│ L1: PROJECT_CONTEXT.md (项目级)                 │
│  - 更新频率：每个模块完成后                      │
│  - 大小：2000字以内                              │
│  - 内容：项目架构 + 已完成模块 + 待办模块        │
│  - 目的：理解项目全貌                           │
└─────────────────────────────────────────────────┘
         ▼
┌─────────────────────────────────────────────────┐
│ L2: MODULE_CONTEXT.md (模块级)                  │
│  - 更新频率：每个子模块完成后                    │
│  - 大小：1000字以内                              │
│  - 内容：模块设计 + 前后端状态 + 遗留问题        │
│  - 目的：理解当前模块                           │
└─────────────────────────────────────────────────┘
         ▼
┌─────────────────────────────────────────────────┐
│ L3: HISTORY.md (任务历史)                       │
│  - 更新频率：每个任务完成后追加                  │
│  - 大小：无限制                                  │
│  - 内容：时间线 + Git提交ID + 决策记录          │
│  - 目的：完整历史追溯                           │
└─────────────────────────────────────────────────┘
```

---

## L0: QUICK_RESUME.md

### 设计理念

**目标**：30秒快速恢复，无需阅读大量文档

**核心内容**：
1. 最新状态（当前在做什么）
2. 最近3次操作（刚做了什么）
3. 一句话恢复（下一步做什么）
4. 预计完成时间
5. 关键上下文（必要信息）

### 更新时机

**主控Claude必须在以下时刻更新**：

1. **阶段开始时**（如进入阶段4）
2. **阶段结束时**（如完成阶段4）
3. **长任务进行中**（每5-10分钟）
4. **遇到问题时**（立即记录）
5. **用户询问进度时**（确保最新）

### 更新模板

```markdown
# 快速恢复（L0）

> 最后更新：2025-11-30 14:23:15

## 最新状态

- **时间**：2025-11-30 14:23:15
- **任务**：用户管理系统
- **当前层级**：模块级 - Auth模块
- **当前步骤**：阶段4 - 后端代码实现
- **执行者**：Codex 5.1

## 最近3次操作

1. 🔄 Auth模块后端登录API实现中（Codex）- 预计5分钟
2. ✅ Auth模块前端登录页面完成（Gemini）- 已提交 commit:abc123f
3. ✅ Auth模块设计三方对抗完成 - Architect批准

## 一句话恢复

继续完成Auth模块后端实现，当前正在实现登录API，下一步是注册API。

## 预计完成时间

约 15 分钟（登录API 5分钟 + 注册API 10分钟）

## 关键上下文

- **技术栈**：Spring Boot + React + MySQL
- **当前文件**：src/main/java/controller/AuthController.java
- **遗留问题**：无
- **依赖**：前端登录页面已完成，等待后端API
```

### 使用场景

#### 场景1：中断后恢复

**用户关闭电脑，第二天早上继续**：

```
@claude

【恢复上次工作】

请读取 docs/progress/QUICK_RESUME.md 并继续完成。
```

**Claude的恢复流程**：

```python
def 恢复工作():
    # 步骤1：读取L0
    quick_resume = read("docs/progress/QUICK_RESUME.md")

    # 解析内容
    当前步骤 = "阶段4 - 后端代码实现"
    当前文件 = "AuthController.java"
    下一步 = "继续实现登录API"

    # 上下文足够，直接继续
    return 继续工作(当前步骤, 当前文件, 下一步)
```

**恢复时间**：约30秒

#### 场景2：手机查看进度

**用户在手机上打开OneDrive查看进度**：

1. 打开OneDrive App
2. 导航到 `docs/progress/QUICK_RESUME.md`
3. 查看"最新状态"和"预计完成时间"
4. 了解当前进度

**优势**：无需打开电脑即可了解工作进度

---

## L1: PROJECT_CONTEXT.md

### 设计理念

**目标**：快速理解项目全貌，了解已完成和待完成的模块

**核心内容**：
1. 项目基本信息
2. 项目架构
3. 已完成模块列表
4. 待完成模块列表
5. 技术决策记录
6. 全局约束

### 更新时机

**主控Claude必须在以下时刻更新**：

1. **阶段P0完成后**（架构设计完成）
2. **每个模块完成后**（如Auth模块完成）
3. **重大技术决策后**（如选择新技术栈）

### 更新示例

**Auth模块完成后**：

```markdown
## 已完成模块

### ✅ Auth模块（2025-11-30完成）

- **功能点**：
  - 用户登录（用户名/邮箱 + 密码）
  - 用户注册（邮箱验证）
  - "记住我"功能（14天token）
  - 忘记密码（邮箱重置）
  - 失败3次锁定10分钟

- **Git提交**：
  - 前端：commit abc123f
  - 后端：commit def456g

- **文档位置**：docs/sessions/20251130-auth/

## 待完成模块

### ⏳ Profile模块

- **功能点**：
  - 查看个人资料
  - 编辑个人资料
  - 头像上传
  - 修改密码

- **依赖**：Auth模块（已完成✅）
- **预计时间**：2天
```

### 使用场景

#### 场景1：新加入的开发者

**新开发者加入项目**：

```
@claude

【了解项目全貌】

请读取 docs/progress/PROJECT_CONTEXT.md 并总结：
1. 项目整体架构
2. 已完成哪些模块
3. 还有哪些待完成
4. 我应该从哪里开始
```

#### 场景2：重启后需要更多上下文

**QUICK_RESUME.md上下文不够时**：

```python
def 恢复工作():
    quick_resume = read("QUICK_RESUME.md")

    if 上下文不够:
        # 读取L1了解项目全貌
        project_context = read("PROJECT_CONTEXT.md")

        # 现在有了完整上下文
        return 继续工作()
```

---

## L2: MODULE_CONTEXT.md

### 设计理念

**目标**：理解当前模块的完整设计和实现状态

**核心内容**：
1. 模块设计文档链接
2. 三方对抗设计结果
3. 前端实现状态
4. 后端实现状态
5. 数据库状态
6. 遗留问题
7. 技术债务

### 更新时机

**主控Claude必须在以下时刻更新**：

1. **阶段1完成后**（三方对抗设计完成）
2. **每个子模块完成后**（如登录功能完成）
3. **发现遗留问题时**（立即记录）
4. **技术债务产生时**（标记待处理）

### 更新示例

**登录功能完成后**：

```markdown
## 前端实现状态

### 已完成

- ✅ 登录页面（Gemini实现）
  - 文件：src/pages/Login.tsx
  - Git提交：abc123f
  - 功能：用户名/邮箱登录 + "记住我" + 忘记密码链接

### 进行中

- 🔄 注册页面（Gemini实现中）
  - 文件：src/pages/Register.tsx
  - 预计完成：10分钟

## 后端实现状态

### 已完成

- ✅ 登录API（Codex实现）
  - 端点：POST /api/auth/login
  - 文件：src/main/java/controller/AuthController.java
  - Git提交：def456g
  - 功能：密码验证 + JWT生成 + "记住我"

### 进行中

- 🔄 注册API（Codex实现中）
  - 端点：POST /api/users/register
  - 文件：src/main/java/controller/AuthController.java
  - 预计完成：10分钟

## 遗留问题

### 🔴 Critical

无

### 🟡 Medium

- [ ] 登录页面缺少验证码（容易被暴力破解）
  - 影响：安全性
  - 计划：Profile模块完成后添加
```

### 使用场景

#### 场景1：了解模块实现状态

```
@claude

【检查Auth模块进度】

请读取 docs/progress/MODULE_CONTEXT.md 并报告：
1. 前端完成了哪些功能
2. 后端完成了哪些API
3. 还有哪些遗留问题
```

#### 场景2：继续未完成的模块

```python
def 恢复工作():
    quick_resume = read("QUICK_RESUME.md")
    project_context = read("PROJECT_CONTEXT.md")

    if 需要模块详情:
        # 读取L2了解模块状态
        module_context = read("MODULE_CONTEXT.md")

        # 找到下一个待实现的功能
        next_task = find_pending_task(module_context)
        return 继续工作(next_task)
```

---

## L3: HISTORY.md

### 设计理念

**目标**：完整记录所有任务的时间线，支持历史追溯

**核心内容**：
1. 每个任务的时间线
2. Git提交ID
3. 关键决策记录
4. 遇到的问题和解决方案
5. 统计信息
6. 里程碑

### 更新时机

**主控Claude必须在以下时刻追加**：

1. **每个任务完成后**（如登录功能完成）
2. **重大决策后**（如技术选型）
3. **遇到问题后**（记录问题和解决方案）
4. **里程碑达成后**（如模块完成）

### 更新示例

```markdown
## 📅 2025-11-30

### ✅ 实现Auth模块登录功能

- **时间**：14:00:00 - 14:25:00（25分钟）
- **阶段**：阶段4 - 代码实现
- **执行者**：
  - 前端：Gemini 3.0 Pro
  - 后端：Codex 5.1
- **Git提交**：
  - 前端：abc123f
  - 后端：def456g
- **状态**：✅ 完成
- **文档**：docs/sessions/20251130-auth/

#### 完成内容

- 前端登录页面（用户名/邮箱 + 密码 + "记住我"）
- 后端登录API（POST /api/auth/login）
- JWT token生成
- "记住我"功能（14天token）
- 失败3次锁定10分钟

#### 关键决策

- **决策1**：使用JWT而非Session
  - 理由：支持前后端分离、无状态、易扩展
  - 备选方案：Session（需要Redis存储）

- **决策2**："记住我"token设置为14天
  - 理由：平衡安全性和用户体验
  - 备选方案：7天（太短）、30天（太长）

#### 遇到的问题

- **问题1**：BCrypt密码验证报错
  - 原因：密码字段长度不够（VARCHAR(50)存不下BCrypt加密后的密码）
  - 解决方案：修改为VARCHAR(255)
  - 耗时：5分钟
```

### 使用场景

#### 场景1：回溯某个决策

```
@claude

【查询技术决策】

请读取 docs/progress/HISTORY.md 并回答：
为什么我们选择JWT而不是Session？
```

#### 场景2：统计项目进度

```
@claude

【统计项目进度】

请读取 docs/progress/HISTORY.md 并统计：
1. 总共完成了多少任务
2. 总耗时多少小时
3. 有多少个Git提交
4. 遇到了哪些问题
```

---

## 恢复流程详解

### 标准恢复流程

```python
def 恢复工作():
    """V4.0标准恢复流程"""

    # 步骤1：读取L0（30秒）
    quick_resume = read("docs/progress/QUICK_RESUME.md")

    # 解析快速恢复信息
    当前状态 = 解析(quick_resume["最新状态"])
    最近操作 = 解析(quick_resume["最近3次操作"])
    恢复指令 = 解析(quick_resume["一句话恢复"])

    # 判断上下文是否足够
    if 上下文足够(当前状态, 最近操作, 恢复指令):
        log("L0上下文足够，直接恢复")
        return 继续工作(恢复指令)

    # 步骤2：读取L1（需要更多上下文）
    log("L0上下文不够，读取L1")
    project_context = read("docs/progress/PROJECT_CONTEXT.md")

    # 解析项目上下文
    项目架构 = 解析(project_context["项目架构"])
    已完成模块 = 解析(project_context["已完成模块"])
    待完成模块 = 解析(project_context["待完成模块"])

    if 上下文足够(当前状态, 项目架构, 已完成模块):
        log("L0+L1上下文足够，恢复工作")
        return 继续工作(恢复指令, 项目架构)

    # 步骤3：读取L2（需要模块详情）
    log("L0+L1上下文不够，读取L2")
    module_context = read("docs/progress/MODULE_CONTEXT.md")

    # 解析模块上下文
    模块设计 = 解析(module_context["模块设计"])
    前端状态 = 解析(module_context["前端实现状态"])
    后端状态 = 解析(module_context["后端实现状态"])
    遗留问题 = 解析(module_context["遗留问题"])

    if 上下文足够(当前状态, 模块设计, 前端状态, 后端状态):
        log("L0+L1+L2上下文足够，恢复工作")
        return 继续工作(恢复指令, 模块设计, 遗留问题)

    # 步骤4：读取L3（需要历史追溯）
    log("需要完整历史，读取L3")
    history = read("docs/progress/HISTORY.md")

    # 解析历史
    时间线 = 解析(history["时间线"])
    Git提交 = 解析(history["Git提交"])
    决策记录 = 解析(history["决策记录"])

    # 现在有了完整上下文
    log("L0+L1+L2+L3完整上下文，恢复工作")
    return 继续工作(恢复指令, 项目架构, 模块设计, 历史记录)
```

### 恢复时间对比

| 层级 | 内容大小 | 阅读时间 | 恢复比例 |
|------|---------|---------|---------|
| L0 | 500字 | 30秒 | 80% |
| L0+L1 | 2500字 | 2分钟 | 95% |
| L0+L1+L2 | 3500字 | 3分钟 | 99% |
| L0+L1+L2+L3 | 无限 | 5分钟+ | 100% |

---

## 最佳实践

### 1. 保持L0最新

**规则**：每5-10分钟更新一次L0

**示例**：

```
阶段4开始 → 更新L0
5分钟后 → 更新L0（进度更新）
10分钟后 → 更新L0（进度更新）
阶段4完成 → 更新L0
```

### 2. L1只记录关键信息

**不要**：把所有细节都放在L1

```markdown
## ❌ 不好的做法

### Auth模块

- 登录功能
  - 前端登录页面
    - 用户名输入框
    - 密码输入框
    - "记住我"复选框
    - 登录按钮
    - ...（太详细）
```

**应该**：只记录关键功能点

```markdown
## ✅ 好的做法

### ✅ Auth模块（2025-11-30完成）

- **功能点**：登录、注册、忘记密码
- **Git提交**：abc123f (前端)、def456g (后端)
- **文档**：docs/sessions/20251130-auth/
```

### 3. L2记录遗留问题

**规则**：所有遗留问题必须记录在L2

```markdown
## 遗留问题

### 🔴 Critical

- [ ] 登录API缺少验证码（容易被暴力破解）
  - 影响：安全性极高风险
  - 计划：本周内添加

### 🟡 Medium

- [ ] 登录页面没有"记住设备"功能
  - 影响：用户体验
  - 计划：下个版本
```

### 4. L3完整记录

**规则**：L3只追加，不删除

```markdown
## 📅 2025-11-30

### ✅ 任务1
...

### ✅ 任务2
...

## 📅 2025-12-01

### ✅ 任务3
...
```

---

## 故障排查

### 问题1：恢复后遗忘上下文

**症状**：读取QUICK_RESUME.md后仍然不知道该做什么

**原因**：L0没有及时更新

**解决**：

```
@claude

L0没有更新，请：
1. 读取 HISTORY.md 了解最近完成的任务
2. 读取 MODULE_CONTEXT.md 了解当前模块状态
3. 更新 QUICK_RESUME.md
4. 继续工作
```

### 问题2：L0与实际不符

**症状**：L0显示"进行中"的任务实际已完成

**原因**：任务完成后忘记更新L0

**解决**：

```
@claude

请立即更新 QUICK_RESUME.md：
- 最新状态：[实际状态]
- 最近3次操作：[实际操作]
- 一句话恢复：[实际下一步]
```

---

**✅ 遵循此指南，V4.0将实现真正的零遗忘工作流！**
