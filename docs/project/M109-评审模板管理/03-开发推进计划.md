# 评审模板管理功能 - 详细开发推进计划

> 基于 ContiNew Admin 开发标准规范
>
> 最后更新：2025-12-21

---

## 目录

- [一、功能需求分析](#一功能需求分析)
- [二、技术难点分析](#二技术难点分析)
- [三、数据库准备阶段](#三数据库准备阶段)
- [四、菜单和权限配置阶段](#四菜单和权限配置阶段)
- [五、后端开发阶段](#五后端开发阶段)
- [六、前端开发阶段](#六前端开发阶段)
- [七、测试验证阶段](#七测试验证阶段)
- [八、部署上线阶段](#八部署上线阶段)

---

## 一、功能需求分析

### 1.1 功能概述

评审模板管理是一个典型的**主子表管理**功能，用于配置项目评审时使用的评分模板。

**核心特点：**
- 主表（`prj_evaluation_template`）存储模板基本信息
- 子表（`prj_evaluation_template_item`）存储评分项详细信息
- 一个模板包含多个评分项
- 评分项按大类分组
- 总分必须等于 100 分

### 1.2 功能清单

#### 列表页功能
1. 分页查询模板列表
2. 条件搜索（模板名称、状态）
3. 新增模板
4. 编辑模板
5. 删除模板（逻辑删除）
6. 查看评分项详情
7. 复制模板
8. 导出模板（可选）

#### 编辑页功能
1. 模板基本信息编辑
2. 评分大类管理（添加/删除/排序）
3. 评分项管理（添加/删除/修改/排序）
4. 实时计算总分
5. 总分校验（必须等于 100）
6. 数据保存（主子表联动）

### 1.3 原型分析

**列表页原型关键信息：**
- 显示：模板编码、模板名称、评分项数量、总分、关联项目类型、状态
- 操作：编辑、查看评分项、复制
- 搜索：模板名称、状态

**编辑页原型关键信息：**
- 基本信息：模板编码、模板名称、模板说明、状态
- 评分项配置：
  - 大类：大类名称、大类排序
  - 评分项：评分项名称、满分值、评分说明、排序
- 总分显示：实时计算，必须等于 100

---

## 二、技术难点分析

### 2.1 主子表级联操作

**难点：**
1. 新增时：需要同时插入主表和多条子表记录
2. 修改时：需要对比子表变化（新增、修改、删除）
3. 删除时：需要级联删除子表记录（逻辑删除）

**解决方案：**
- 使用 `@Transactional` 保证数据一致性
- ServiceImpl 中实现 `afterCreate`、`afterUpdate`、`beforeDelete` 钩子
- 子表操作封装成独立的 Service 方法

### 2.2 逻辑删除实现

**难点：**
- 两个表都需要 `deleted` 字段
- 删除时需要级联更新子表的 `deleted` 字段
- 查询时需要自动过滤已删除数据

**解决方案：**
- 实体类添加 `@TableLogic` 注解
- MyBatis Plus 自动处理逻辑删除
- 级联删除在 Service 层手动处理

### 2.3 总分实时计算与校验

**难点：**
- 前端需要实时计算所有评分项的总分
- 保存前需要校验总分是否等于 100
- 删除评分项时需要重新计算总分

**解决方案：**
- 前端使用 `computed` 计算总分
- 保存前使用 `@Valid` 校验
- 后端二次校验总分

### 2.4 复制模板功能

**难点：**
- 需要复制主表和所有子表记录
- 复制后的模板编码需要自动生成

**解决方案：**
- Service 层实现 `copyTemplate` 方法
- 使用事务保证主子表同时复制成功
- 编码自动生成规则：`TPL_` + 时间戳或自增ID

---

## 三、数据库准备阶段

### 3.1 修改数据库脚本

**任务：为两个表添加 `deleted` 字段**

**文件位置：** `continew-admin/continew-server/src/main/resources/db/changelog/`

**操作步骤：**

#### 步骤 1：创建新的 changeset

在 `02-数据库脚本.sql` 文件末尾添加：

```sql
-- changeset system:prj_evaluation_template_002
-- comment 为评审模板表添加逻辑删除字段
ALTER TABLE `prj_evaluation_template`
ADD COLUMN `deleted` BIGINT NOT NULL DEFAULT 0 COMMENT '逻辑删除标识（0未删除 时间戳已删除）' AFTER `update_time`;

-- changeset system:prj_evaluation_template_item_002
-- comment 为评审模板评分项表添加逻辑删除字段
ALTER TABLE `prj_evaluation_template_item`
ADD COLUMN `deleted` BIGINT NOT NULL DEFAULT 0 COMMENT '逻辑删除标识（0未删除 时间戳已删除）' AFTER `update_time`;
```

**注意事项：**
1. changeset 名称必须唯一
2. `deleted` 字段使用 `BIGINT` 类型存储时间戳
3. 默认值为 `0` 表示未删除
4. 删除时存储删除时间的时间戳

#### 步骤 2：验证数据库脚本

启动后端应用，Liquibase 会自动执行脚本：

```bash
cd continew-admin
mvn spring-boot:run -pl continew-server
```

查看控制台日志，确认 changeset 执行成功。

#### 步骤 3：验证数据库表结构

连接数据库，执行以下 SQL 验证：

```sql
-- 查看主表结构
DESC prj_evaluation_template;

-- 查看子表结构
DESC prj_evaluation_template_item;
```

确认 `deleted` 字段已添加。

### 3.2 验证测试数据

确认初始化数据正常插入：

```sql
-- 查询模板列表
SELECT * FROM prj_evaluation_template WHERE deleted = 0;

-- 查询某个模板的评分项
SELECT * FROM prj_evaluation_template_item
WHERE template_id = 1 AND deleted = 0
ORDER BY category_sort, item_sort;
```

---

## 四、菜单和权限配置阶段

### 4.1 菜单结构设计

**菜单层级：**
```
配置管理（目录）
└── 评审模板管理（菜单）
    ├── 查询（按钮）
    ├── 新增（按钮）
    ├── 修改（按钮）
    ├── 删除（按钮）
    ├── 详情（按钮）
    ├── 复制（按钮）
    └── 导出（按钮，可选）
```

### 4.2 菜单创建步骤

#### 步骤 1：登录系统，进入菜单管理

访问：`http://localhost:5173/system/menu`

#### 步骤 2：创建父级目录（如果不存在）

**操作：** 点击【新增】按钮

**配置：**
- 菜单类型：目录
- 菜单标题：配置管理
- 菜单图标：icon-settings
- 路由地址：/config
- 组件名称：Layout
- 排序：根据实际情况
- 状态：启用
- 是否隐藏：否
- 是否缓存：是

**权限标识：** 无需填写

#### 步骤 3：创建评审模板管理菜单

**操作：** 选择"配置管理"目录，点击【新增】按钮

**配置：**
- 菜单类型：菜单
- 上级菜单：配置管理
- 菜单标题：评审模板管理
- 菜单图标：icon-file-document（或其他合适图标）
- 路由地址：/config/evaluation-template
- 组件名称：ConfigEvaluationTemplate
- 组件路径：config/evaluation-template/index
- 权限标识：config:evaluation-template:list
- 排序：根据实际情况
- 状态：启用
- 是否隐藏：否
- 是否缓存：是
- 是否外链：否

#### 步骤 4：创建按钮级权限

依次创建以下按钮（上级菜单选择"评审模板管理"）：

**1. 查询按钮**
- 菜单类型：按钮
- 菜单标题：查询
- 权限标识：`config:evaluation-template:list`

**2. 新增按钮**
- 菜单类型：按钮
- 菜单标题：新增
- 权限标识：`config:evaluation-template:create`

**3. 修改按钮**
- 菜单类型：按钮
- 菜单标题：修改
- 权限标识：`config:evaluation-template:update`

**4. 删除按钮**
- 菜单类型：按钮
- 菜单标题：删除
- 权限标识：`config:evaluation-template:delete`

**5. 详情按钮**
- 菜单类型：按钮
- 菜单标题：详情
- 权限标识：`config:evaluation-template:get`

**6. 复制按钮**
- 菜单类型：按钮
- 菜单标题：复制
- 权限标识：`config:evaluation-template:copy`

**7. 导出按钮（可选）**
- 菜单类型：按钮
- 菜单标题：导出
- 权限标识：`config:evaluation-template:export`

### 4.3 权限分配

#### 步骤 1：进入角色管理

访问：`http://localhost:5173/system/role`

#### 步骤 2：为管理员角色分配权限

1. 找到"超级管理员"或"管理员"角色
2. 点击【修改权限】
3. 在权限树中勾选：
   - 配置管理
     - 评审模板管理（勾选菜单及所有按钮权限）
4. 点击【确定】保存

#### 步骤 3：刷新页面，验证菜单显示

刷新浏览器，确认左侧菜单中显示"配置管理 > 评审模板管理"。

### 4.4 字典数据准备（可选）

**评审模板状态字典：**

如果需要独立的模板状态字典，可以创建：

**字典编码：** `evaluation_template_status`

**字典项：**
- 标签：启用，值：1，颜色：green
- 标签：停用，值：2，颜色：red

**注意：** 由于已有通用的 `dis_enable_status` 字典，可以直接使用，无需新建。

---

## 五、后端开发阶段

### 5.1 项目结构规划

```
continew-admin/continew-system/src/main/java/top/continew/admin/system/
├── controller/
│   └── EvaluationTemplateController.java
├── service/
│   ├── EvaluationTemplateService.java
│   └── impl/
│       └── EvaluationTemplateServiceImpl.java
├── mapper/
│   ├── EvaluationTemplateMapper.java
│   ├── EvaluationTemplateMapper.xml
│   ├── EvaluationTemplateItemMapper.java
│   └── EvaluationTemplateItemMapper.xml
└── model/
    ├── entity/
    │   ├── EvaluationTemplateDO.java
    │   └── EvaluationTemplateItemDO.java
    ├── req/
    │   ├── EvaluationTemplateReq.java
    │   └── EvaluationTemplateItemReq.java
    ├── resp/
    │   ├── EvaluationTemplateResp.java
    │   └── EvaluationTemplateDetailResp.java
    └── query/
        └── EvaluationTemplateQuery.java
```

### 5.2 实体类开发

#### 步骤 1：创建主表实体类

**文件：** `model/entity/EvaluationTemplateDO.java`

**关键要点：**
```java
@Data
@TableName("prj_evaluation_template")
public class EvaluationTemplateDO extends BaseDO {

    private static final long serialVersionUID = 1L;

    /** 模板编码 */
    private String code;

    /** 模板名称 */
    private String name;

    /** 模板说明 */
    private String description;

    /** 总分 */
    private BigDecimal totalScore;

    /** 评分项数量 */
    private Integer itemCount;

    /** 评分大类数量 */
    private Integer categoryCount;

    /** 状态（1启用 2停用） */
    private DisEnableStatusEnum status;

    /** 排序 */
    private Integer sort;

    /** 备注 */
    private String remark;

    /** 逻辑删除标识 */
    @TableLogic
    private Long deleted;
}
```

**注意事项：**
1. 继承 `BaseDO`（包含 id、createUser、createTime 等字段）
2. 使用 `@TableLogic` 标记逻辑删除字段
3. 状态使用 `DisEnableStatusEnum` 枚举
4. 总分使用 `BigDecimal` 类型
5. 所有字段必须有中文注释

#### 步骤 2：创建子表实体类

**文件：** `model/entity/EvaluationTemplateItemDO.java`

**关键要点：**
```java
@Data
@TableName("prj_evaluation_template_item")
public class EvaluationTemplateItemDO extends BaseDO {

    private static final long serialVersionUID = 1L;

    /** 模板ID */
    private Long templateId;

    /** 大类名称 */
    private String categoryName;

    /** 大类排序 */
    private Integer categorySort;

    /** 评分项名称 */
    private String itemName;

    /** 评分项排序 */
    private Integer itemSort;

    /** 满分值 */
    private BigDecimal maxScore;

    /** 评分说明 */
    private String description;

    /** 逻辑删除标识 */
    @TableLogic
    private Long deleted;
}
```

### 5.3 请求参数开发

#### 步骤 1：创建主表请求参数

**文件：** `model/req/EvaluationTemplateReq.java`

**关键要点：**
```java
@Data
@Schema(description = "评审模板创建或修改请求参数")
public class EvaluationTemplateReq implements Serializable {

    /** 模板编码 */
    @Schema(description = "模板编码", example = "TPL_001")
    @NotBlank(message = "模板编码不能为空")
    @Length(max = 20, message = "模板编码长度不能超过 {max} 个字符")
    private String code;

    /** 模板名称 */
    @Schema(description = "模板名称", example = "产品研发评审模板")
    @NotBlank(message = "模板名称不能为空")
    @Length(max = 50, message = "模板名称长度不能超过 {max} 个字符")
    private String name;

    /** 模板说明 */
    @Schema(description = "模板说明")
    @Length(max = 500, message = "模板说明长度不能超过 {max} 个字符")
    private String description;

    /** 状态 */
    @Schema(description = "状态", example = "1")
    @NotNull(message = "状态不能为空")
    private DisEnableStatusEnum status;

    /** 排序 */
    @Schema(description = "排序", example = "1")
    private Integer sort;

    /** 备注 */
    @Schema(description = "备注")
    @Length(max = 255, message = "备注长度不能超过 {max} 个字符")
    private String remark;

    /** 评分项列表 */
    @Schema(description = "评分项列表")
    @NotEmpty(message = "评分项列表不能为空")
    @Valid
    private List<EvaluationTemplateItemReq> items;
}
```

**重点：** 包含子表数据列表 `items`

#### 步骤 2：创建子表请求参数

**文件：** `model/req/EvaluationTemplateItemReq.java`

**关键要点：**
```java
@Data
@Schema(description = "评审模板评分项请求参数")
public class EvaluationTemplateItemReq implements Serializable {

    /** 主键ID（修改时需要） */
    @Schema(description = "主键ID")
    private Long id;

    /** 大类名称 */
    @Schema(description = "大类名称", example = "一、项目创新性")
    @NotBlank(message = "大类名称不能为空")
    @Length(max = 100, message = "大类名称长度不能超过 {max} 个字符")
    private String categoryName;

    /** 大类排序 */
    @Schema(description = "大类排序", example = "1")
    @NotNull(message = "大类排序不能为空")
    private Integer categorySort;

    /** 评分项名称 */
    @Schema(description = "评分项名称", example = "技术创新程度")
    @NotBlank(message = "评分项名称不能为空")
    @Length(max = 100, message = "评分项名称长度不能超过 {max} 个字符")
    private String itemName;

    /** 评分项排序 */
    @Schema(description = "评分项排序", example = "1")
    @NotNull(message = "评分项排序不能为空")
    private Integer itemSort;

    /** 满分值 */
    @Schema(description = "满分值", example = "10.00")
    @NotNull(message = "满分值不能为空")
    @DecimalMin(value = "0.01", message = "满分值必须大于 0")
    @DecimalMax(value = "100.00", message = "满分值不能超过 100")
    private BigDecimal maxScore;

    /** 评分说明 */
    @Schema(description = "评分说明")
    @Length(max = 500, message = "评分说明长度不能超过 {max} 个字符")
    private String description;
}
```

### 5.4 响应参数开发

#### 步骤 1：创建列表响应参数

**文件：** `model/resp/EvaluationTemplateResp.java`

**关键要点：**
```java
@Data
@Schema(description = "评审模板响应参数")
public class EvaluationTemplateResp extends BaseDetailResp {

    /** 模板编码 */
    @Schema(description = "模板编码", example = "TPL_001")
    private String code;

    /** 模板名称 */
    @Schema(description = "模板名称", example = "产品研发评审模板")
    private String name;

    /** 模板说明 */
    @Schema(description = "模板说明")
    private String description;

    /** 总分 */
    @Schema(description = "总分", example = "100.00")
    private BigDecimal totalScore;

    /** 评分项数量 */
    @Schema(description = "评分项数量", example = "8")
    private Integer itemCount;

    /** 评分大类数量 */
    @Schema(description = "评分大类数量", example = "5")
    private Integer categoryCount;

    /** 状态 */
    @Schema(description = "状态", example = "1")
    private DisEnableStatusEnum status;

    /** 排序 */
    @Schema(description = "排序", example = "1")
    private Integer sort;

    /** 备注 */
    @Schema(description = "备注")
    private String remark;
}
```

#### 步骤 2：创建详情响应参数

**文件：** `model/resp/EvaluationTemplateDetailResp.java`

**关键要点：**
```java
@Data
@Schema(description = "评审模板详情响应参数")
public class EvaluationTemplateDetailResp extends EvaluationTemplateResp {

    /** 评分项列表 */
    @Schema(description = "评分项列表")
    private List<EvaluationTemplateItemResp> items;
}
```

**注意：** 包含子表数据列表

#### 步骤 3：创建评分项响应参数

**文件：** `model/resp/EvaluationTemplateItemResp.java`

**关键要点：**
```java
@Data
@Schema(description = "评审模板评分项响应参数")
public class EvaluationTemplateItemResp implements Serializable {

    /** 主键ID */
    @Schema(description = "主键ID")
    private Long id;

    /** 模板ID */
    @Schema(description = "模板ID")
    private Long templateId;

    /** 大类名称 */
    @Schema(description = "大类名称", example = "一、项目创新性")
    private String categoryName;

    /** 大类排序 */
    @Schema(description = "大类排序", example = "1")
    private Integer categorySort;

    /** 评分项名称 */
    @Schema(description = "评分项名称", example = "技术创新程度")
    private String itemName;

    /** 评分项排序 */
    @Schema(description = "评分项排序", example = "1")
    private Integer itemSort;

    /** 满分值 */
    @Schema(description = "满分值", example = "10.00")
    private BigDecimal maxScore;

    /** 评分说明 */
    @Schema(description = "评分说明")
    private String description;
}
```

### 5.5 查询条件开发

**文件：** `model/query/EvaluationTemplateQuery.java`

**关键要点：**
```java
@Data
@Schema(description = "评审模板查询条件")
public class EvaluationTemplateQuery implements Serializable {

    /** 关键词 */
    @Schema(description = "关键词（模板名称）", example = "产品研发")
    private String name;

    /** 状态 */
    @Schema(description = "状态", example = "1")
    private DisEnableStatusEnum status;

    /** 创建时间 */
    @Schema(description = "创建时间")
    private List<LocalDateTime> createTime;
}
```

### 5.6 Mapper 开发

#### 步骤 1：创建主表 Mapper 接口

**文件：** `mapper/EvaluationTemplateMapper.java`

**关键要点：**
```java
@Mapper
public interface EvaluationTemplateMapper extends DataPermissionMapper<EvaluationTemplateDO> {

    /**
     * 根据编码查询
     *
     * @param code 模板编码
     * @return 模板信息
     */
    @Select("SELECT * FROM prj_evaluation_template WHERE code = #{code} AND deleted = 0")
    EvaluationTemplateDO selectByCode(@Param("code") String code);
}
```

#### 步骤 2：创建子表 Mapper 接口

**文件：** `mapper/EvaluationTemplateItemMapper.java`

**关键要点：**
```java
@Mapper
public interface EvaluationTemplateItemMapper extends BaseMapper<EvaluationTemplateItemDO> {

    /**
     * 根据模板ID查询评分项列表
     *
     * @param templateId 模板ID
     * @return 评分项列表
     */
    @Select("SELECT * FROM prj_evaluation_template_item WHERE template_id = #{templateId} AND deleted = 0 ORDER BY category_sort, item_sort")
    List<EvaluationTemplateItemDO> selectByTemplateId(@Param("templateId") Long templateId);

    /**
     * 根据模板ID逻辑删除评分项
     *
     * @param templateId 模板ID
     * @return 删除数量
     */
    @Update("UPDATE prj_evaluation_template_item SET deleted = #{deleteTime} WHERE template_id = #{templateId} AND deleted = 0")
    int deleteByTemplateId(@Param("templateId") Long templateId, @Param("deleteTime") Long deleteTime);
}
```

**注意：** 逻辑删除需要手动实现

### 5.7 Service 开发

#### 步骤 1：创建 Service 接口

**文件：** `service/EvaluationTemplateService.java`

**关键要点：**
```java
public interface EvaluationTemplateService extends
    BaseService<EvaluationTemplateResp, EvaluationTemplateDetailResp, EvaluationTemplateQuery, EvaluationTemplateReq>,
    IService<EvaluationTemplateDO> {

    /**
     * 复制模板
     *
     * @param id 模板ID
     * @return 新模板ID
     */
    Long copyTemplate(Long id);

    /**
     * 根据编码查询
     *
     * @param code 模板编码
     * @return 模板信息
     */
    EvaluationTemplateDO getByCode(String code);
}
```

#### 步骤 2：创建 ServiceImpl 实现类

**文件：** `service/impl/EvaluationTemplateServiceImpl.java`

**核心实现要点：**

**1. 类定义和依赖注入**
```java
@Slf4j
@Service
@RequiredArgsConstructor
public class EvaluationTemplateServiceImpl extends
    BaseServiceImpl<EvaluationTemplateMapper, EvaluationTemplateDO, EvaluationTemplateResp, EvaluationTemplateDetailResp, EvaluationTemplateQuery, EvaluationTemplateReq>
    implements EvaluationTemplateService {

    private final EvaluationTemplateItemMapper itemMapper;
}
```

**2. 查询详情（包含子表数据）**
```java
@Override
public EvaluationTemplateDetailResp get(Long id) {
    EvaluationTemplateDetailResp resp = super.get(id);
    if (resp == null) {
        return null;
    }

    // 查询评分项列表
    List<EvaluationTemplateItemDO> itemList = itemMapper.selectByTemplateId(id);
    List<EvaluationTemplateItemResp> items = BeanUtil.copyToList(itemList, EvaluationTemplateItemResp.class);
    resp.setItems(items);

    return resp;
}
```

**3. 创建前校验**
```java
@Override
public void beforeCreate(EvaluationTemplateReq req) {
    // 校验编码唯一性
    this.checkCodeRepeat(req.getCode(), null);

    // 校验总分
    this.checkTotalScore(req.getItems());
}

private void checkCodeRepeat(String code, Long excludeId) {
    EvaluationTemplateDO template = baseMapper.selectByCode(code);
    if (template != null && !Objects.equals(template.getId(), excludeId)) {
        throw new BusinessException("模板编码 [{}] 已存在", code);
    }
}

private void checkTotalScore(List<EvaluationTemplateItemReq> items) {
    BigDecimal totalScore = items.stream()
        .map(EvaluationTemplateItemReq::getMaxScore)
        .reduce(BigDecimal.ZERO, BigDecimal::add);

    if (totalScore.compareTo(new BigDecimal("100.00")) != 0) {
        throw new BusinessException("总分必须等于 100，当前总分为 {}", totalScore);
    }
}
```

**4. 创建后处理（保存子表）**
```java
@Override
@Transactional(rollbackFor = Exception.class)
public void afterCreate(EvaluationTemplateReq req, EvaluationTemplateDO template) {
    Long templateId = template.getId();

    // 保存评分项
    List<EvaluationTemplateItemDO> itemList = BeanUtil.copyToList(req.getItems(), EvaluationTemplateItemDO.class);
    itemList.forEach(item -> item.setTemplateId(templateId));

    // 批量插入
    itemMapper.insertBatch(itemList);

    // 更新统计字段
    updateStatistics(templateId, req.getItems());
}

private void updateStatistics(Long templateId, List<EvaluationTemplateItemReq> items) {
    // 计算评分项数量
    int itemCount = items.size();

    // 计算大类数量
    long categoryCount = items.stream()
        .map(EvaluationTemplateItemReq::getCategoryName)
        .distinct()
        .count();

    // 计算总分
    BigDecimal totalScore = items.stream()
        .map(EvaluationTemplateItemReq::getMaxScore)
        .reduce(BigDecimal.ZERO, BigDecimal::add);

    // 更新主表
    baseMapper.lambdaUpdate()
        .set(EvaluationTemplateDO::getItemCount, itemCount)
        .set(EvaluationTemplateDO::getCategoryCount, categoryCount)
        .set(EvaluationTemplateDO::getTotalScore, totalScore)
        .eq(EvaluationTemplateDO::getId, templateId)
        .update();
}
```

**5. 更新前校验**
```java
@Override
public void beforeUpdate(EvaluationTemplateReq req, Long id) {
    // 校验总分
    this.checkTotalScore(req.getItems());
}
```

**6. 更新后处理（更新子表）**
```java
@Override
@Transactional(rollbackFor = Exception.class)
public void afterUpdate(EvaluationTemplateReq req, EvaluationTemplateDO newTemplate, EvaluationTemplateDO oldTemplate) {
    Long templateId = newTemplate.getId();

    // 获取现有评分项
    List<EvaluationTemplateItemDO> existingItems = itemMapper.selectByTemplateId(templateId);
    Map<Long, EvaluationTemplateItemDO> existingItemMap = existingItems.stream()
        .collect(Collectors.toMap(EvaluationTemplateItemDO::getId, item -> item));

    // 处理评分项
    List<EvaluationTemplateItemReq> reqItems = req.getItems();
    Set<Long> reqItemIds = new HashSet<>();

    for (EvaluationTemplateItemReq reqItem : reqItems) {
        if (reqItem.getId() != null) {
            // 更新现有评分项
            reqItemIds.add(reqItem.getId());
            EvaluationTemplateItemDO item = BeanUtil.copyProperties(reqItem, EvaluationTemplateItemDO.class);
            item.setTemplateId(templateId);
            itemMapper.updateById(item);
        } else {
            // 新增评分项
            EvaluationTemplateItemDO item = BeanUtil.copyProperties(reqItem, EvaluationTemplateItemDO.class);
            item.setTemplateId(templateId);
            itemMapper.insert(item);
        }
    }

    // 删除不存在的评分项
    existingItemMap.forEach((id, item) -> {
        if (!reqItemIds.contains(id)) {
            itemMapper.deleteById(id);
        }
    });

    // 更新统计字段
    updateStatistics(templateId, req.getItems());
}
```

**7. 删除前处理（级联删除子表）**
```java
@Override
@Transactional(rollbackFor = Exception.class)
public void beforeDelete(Long id) {
    // 逻辑删除所有评分项
    long deleteTime = System.currentTimeMillis();
    itemMapper.deleteByTemplateId(id, deleteTime);
}
```

**8. 复制模板**
```java
@Override
@Transactional(rollbackFor = Exception.class)
public Long copyTemplate(Long id) {
    // 查询原模板
    EvaluationTemplateDetailResp source = this.get(id);
    CheckUtils.throwIfNull(source, "模板不存在");

    // 复制主表
    EvaluationTemplateReq req = BeanUtil.copyProperties(source, EvaluationTemplateReq.class);
    req.setCode(generateCode());  // 生成新编码
    req.setName(source.getName() + "_副本");

    // 复制评分项
    List<EvaluationTemplateItemReq> items = BeanUtil.copyToList(source.getItems(), EvaluationTemplateItemReq.class);
    items.forEach(item -> item.setId(null));  // 清空ID
    req.setItems(items);

    // 保存新模板
    return this.create(req);
}

private String generateCode() {
    // 生成编码：TPL_ + 时间戳后6位
    return "TPL_" + String.valueOf(System.currentTimeMillis()).substring(7);
}
```

**9. 根据编码查询**
```java
@Override
public EvaluationTemplateDO getByCode(String code) {
    return baseMapper.selectByCode(code);
}
```

### 5.8 Controller 开发

**文件：** `controller/EvaluationTemplateController.java`

**关键要点：**
```java
@Tag(name = "评审模板管理 API")
@Validated
@RestController
@RequiredArgsConstructor
@CrudRequestMapping(value = "/config/evaluation-template", api = {
    Api.PAGE, Api.LIST, Api.GET, Api.CREATE, Api.UPDATE, Api.BATCH_DELETE, Api.EXPORT
})
public class EvaluationTemplateController extends
    BaseController<EvaluationTemplateService, EvaluationTemplateResp, EvaluationTemplateDetailResp, EvaluationTemplateQuery, EvaluationTemplateReq> {

    @Operation(summary = "复制模板", description = "复制评审模板及其所有评分项")
    @Parameter(name = "id", description = "ID", example = "1", in = ParameterIn.PATH)
    @SaCheckPermission("config:evaluation-template:copy")
    @PostMapping("/{id}/copy")
    public Long copyTemplate(@PathVariable Long id) {
        return baseService.copyTemplate(id);
    }
}
```

**说明：**
1. 基础 CRUD 由 `@CrudRequestMapping` 自动提供
2. 只需要添加复制功能
3. 权限校验使用 `@SaCheckPermission`

---

## 六、前端开发阶段

### 6.1 项目结构规划

```
continew-admin-ui/src/
├── apis/
│   └── config/
│       ├── evaluation-template.ts
│       └── type.ts
└── views/
    └── config/
        └── evaluation-template/
            ├── index.vue
            ├── AddDrawer.vue
            ├── DetailDrawer.vue
            └── components/
                ├── CategorySection.vue
                └── ScoreItemCard.vue
```

### 6.2 API 接口开发

#### 步骤 1：定义类型

**文件：** `apis/config/type.ts`

**关键要点：**
```typescript
/** 评审模板查询条件 */
export interface EvaluationTemplateQuery {
  name?: string
  status?: number
  createTime?: string[]
}

/** 评审模板分页查询 */
export interface EvaluationTemplatePageQuery extends EvaluationTemplateQuery, PageQuery {}

/** 评分项 */
export interface EvaluationTemplateItem {
  id?: number
  categoryName: string
  categorySort: number
  itemName: string
  itemSort: number
  maxScore: number
  description?: string
}

/** 评审模板响应 */
export interface EvaluationTemplateResp {
  id: number
  code: string
  name: string
  description?: string
  totalScore: number
  itemCount: number
  categoryCount: number
  status: number
  sort: number
  remark?: string
  createTime: string
  updateTime: string
}

/** 评审模板详情响应 */
export interface EvaluationTemplateDetailResp extends EvaluationTemplateResp {
  items: EvaluationTemplateItem[]
}

/** 评审模板请求 */
export interface EvaluationTemplateReq {
  code: string
  name: string
  description?: string
  status: number
  sort?: number
  remark?: string
  items: EvaluationTemplateItem[]
}
```

#### 步骤 2：定义 API 方法

**文件：** `apis/config/evaluation-template.ts`

**关键要点：**
```typescript
import type * as T from './type'
import http from '@/utils/http'

const BASE_URL = '/config/evaluation-template'

/** @desc 分页查询评审模板 */
export function pageEvaluationTemplate(query: T.EvaluationTemplatePageQuery) {
  return http.get<PageRes<T.EvaluationTemplateResp[]>>(`${BASE_URL}`, query)
}

/** @desc 查询评审模板列表 */
export function listEvaluationTemplate(query: Partial<T.EvaluationTemplateQuery>) {
  return http.get<T.EvaluationTemplateResp[]>(`${BASE_URL}/list`, query)
}

/** @desc 查询评审模板详情 */
export function getEvaluationTemplate(id: number) {
  return http.get<T.EvaluationTemplateDetailResp>(`${BASE_URL}/${id}`)
}

/** @desc 新增评审模板 */
export function addEvaluationTemplate(data: T.EvaluationTemplateReq) {
  return http.post(`${BASE_URL}`, data)
}

/** @desc 修改评审模板 */
export function updateEvaluationTemplate(data: T.EvaluationTemplateReq, id: number) {
  return http.put(`${BASE_URL}/${id}`, data)
}

/** @desc 删除评审模板 */
export function deleteEvaluationTemplate(id: number) {
  return http.del(`${BASE_URL}`, { ids: [id] })
}

/** @desc 复制评审模板 */
export function copyEvaluationTemplate(id: number) {
  return http.post<number>(`${BASE_URL}/${id}/copy`)
}

/** @desc 导出评审模板 */
export function exportEvaluationTemplate(query: T.EvaluationTemplateQuery) {
  return http.download(`${BASE_URL}/export`, query)
}
```

### 6.3 列表页面开发

**文件：** `views/config/evaluation-template/index.vue`

**核心要点：**

**1. 查询表单配置**
```vue
<script setup lang="ts">
const queryFormColumns: ColumnItem[] = reactive([
  {
    type: 'input',
    label: '模板名称',
    field: 'name',
    span: { xs: 24, sm: 8, xxl: 8 },
    props: {
      placeholder: '请输入模板名称',
    },
  },
  {
    type: 'select',
    label: '状态',
    field: 'status',
    span: { xs: 24, sm: 6, xxl: 8 },
    props: {
      options: DisEnableStatusList,
      placeholder: '请选择状态',
    },
  },
  {
    type: 'range-picker',
    label: '创建时间',
    field: 'createTime',
    span: { xs: 24, sm: 10, xxl: 8 },
  },
])
</script>
```

**2. 表格列配置**
```vue
<script setup lang="ts">
const columns: TableInstance['columns'] = [
  {
    title: '序号',
    width: 66,
    align: 'center',
    render: ({ rowIndex }) => h('span', {}, rowIndex + 1 + (pagination.current - 1) * pagination.pageSize),
  },
  { title: '模板编码', dataIndex: 'code', minWidth: 120 },
  { title: '模板名称', dataIndex: 'name', minWidth: 180 },
  {
    title: '评分项数量',
    dataIndex: 'itemCount',
    width: 120,
    render: ({ record }) => `${record.itemCount}项（${record.categoryCount}大类）`
  },
  { title: '总分', dataIndex: 'totalScore', width: 80, align: 'center' },
  { title: '状态', dataIndex: 'status', slotName: 'status', width: 80, align: 'center' },
  { title: '创建时间', dataIndex: 'createTime', width: 180 },
  {
    title: '操作',
    dataIndex: 'action',
    slotName: 'action',
    width: 180,
    align: 'center',
    fixed: !isMobile() ? 'right' : undefined,
  },
]
</script>
```

**3. 操作按钮**
```vue
<template #action="{ record }">
  <a-space>
    <a-link v-permission="['config:evaluation-template:get']" @click="onDetail(record)">
      详情
    </a-link>
    <a-link v-permission="['config:evaluation-template:update']" @click="onUpdate(record)">
      修改
    </a-link>
    <a-dropdown>
      <a-button type="text" size="mini">
        <template #icon><icon-more :size="16" /></template>
      </a-button>
      <template #content>
        <a-doption v-permission="['config:evaluation-template:copy']" @click="onCopy(record)">
          复制
        </a-doption>
        <a-doption v-permission="['config:evaluation-template:delete']">
          <a-link status="danger" @click="onDelete(record)">删除</a-link>
        </a-doption>
      </template>
    </a-dropdown>
  </a-space>
</template>
```

**4. 复制功能**
```vue
<script setup lang="ts">
const onCopy = async (record: EvaluationTemplateResp) => {
  try {
    const { data } = await copyEvaluationTemplate(record.id)
    Message.success('复制成功')
    search()
    // 自动打开编辑
    onUpdate({ id: data } as EvaluationTemplateResp)
  } catch (error) {
    console.error('复制失败', error)
  }
}
</script>
```

### 6.4 编辑抽屉开发

**文件：** `views/config/evaluation-template/AddDrawer.vue`

**核心要点：**

**1. 表单数据结构**
```vue
<script setup lang="ts">
interface Category {
  name: string
  sort: number
  items: {
    id?: number
    name: string
    sort: number
    maxScore: number
    description?: string
  }[]
}

const [form, resetForm] = useResetReactive({
  code: '',
  name: '',
  description: '',
  status: 1 as Status,
  sort: 0,
  remark: '',
  categories: [] as Category[],
})
</script>
```

**2. 基本信息表单**
```vue
<GiForm ref="formRef" v-model="form" :columns="basicColumns" />
```

**3. 评分项配置区域**
```vue
<template>
  <!-- 总分显示 -->
  <div class="total-score-display">
    <div class="total-score-label">当前总分</div>
    <div class="total-score-value" :class="{ error: totalScore !== 100 }">
      {{ totalScore }}
    </div>
    <div class="total-score-hint">（必须等于100分）</div>
  </div>

  <!-- 评分大类列表 -->
  <div v-for="(category, categoryIndex) in form.categories" :key="categoryIndex" class="category-section">
    <div class="category-header">
      <div class="category-title">
        <a-input v-model="category.name" placeholder="大类名称，如：一、项目创新性" />
        <a-input-number v-model="category.sort" placeholder="排序" :min="1" style="width: 100px; margin-left: 10px;" />
      </div>
      <a-button type="text" status="danger" @click="removeCategory(categoryIndex)">
        <template #icon><icon-delete /></template>
        删除大类
      </a-button>
    </div>

    <!-- 评分项列表 -->
    <div v-for="(item, itemIndex) in category.items" :key="itemIndex" class="score-item">
      <div class="score-item-header">
        <span>评分项 {{ itemIndex + 1 }}</span>
        <a-button type="text" size="mini" status="danger" @click="removeItem(categoryIndex, itemIndex)">
          <template #icon><icon-close /></template>
        </a-button>
      </div>
      <a-row :gutter="16">
        <a-col :span="12">
          <a-form-item label="评分项名称" required>
            <a-input v-model="item.name" placeholder="如：技术创新程度" />
          </a-form-item>
        </a-col>
        <a-col :span="6">
          <a-form-item label="满分值" required>
            <a-input-number v-model="item.maxScore" :min="0.01" :max="100" :precision="2" placeholder="分值" />
          </a-form-item>
        </a-col>
        <a-col :span="6">
          <a-form-item label="排序">
            <a-input-number v-model="item.sort" :min="1" placeholder="排序" />
          </a-form-item>
        </a-col>
        <a-col :span="24">
          <a-form-item label="评分说明">
            <a-textarea v-model="item.description" placeholder="评分说明" :max-length="500" show-word-limit />
          </a-form-item>
        </a-col>
      </a-row>
    </div>

    <!-- 添加评分项按钮 -->
    <a-button type="dashed" long @click="addItem(categoryIndex)">
      <template #icon><icon-plus /></template>
      添加评分项
    </a-button>
  </div>

  <!-- 添加大类按钮 -->
  <a-button type="dashed" long @click="addCategory" style="margin-top: 20px;">
    <template #icon><icon-plus /></template>
    添加评分大类
  </a-button>
</template>
```

**4. 总分计算**
```vue
<script setup lang="ts">
const totalScore = computed(() => {
  return form.categories.reduce((total, category) => {
    return total + category.items.reduce((sum, item) => sum + (item.maxScore || 0), 0)
  }, 0)
})
</script>
```

**5. 添加/删除大类和评分项**
```vue
<script setup lang="ts">
const addCategory = () => {
  form.categories.push({
    name: '',
    sort: form.categories.length + 1,
    items: [],
  })
}

const removeCategory = (categoryIndex: number) => {
  Modal.confirm({
    title: '确认删除',
    content: '是否确定删除该评分大类及其所有评分项？',
    onOk: () => {
      form.categories.splice(categoryIndex, 1)
    },
  })
}

const addItem = (categoryIndex: number) => {
  const category = form.categories[categoryIndex]
  category.items.push({
    name: '',
    sort: category.items.length + 1,
    maxScore: 0,
    description: '',
  })
}

const removeItem = (categoryIndex: number, itemIndex: number) => {
  form.categories[categoryIndex].items.splice(itemIndex, 1)
}
</script>
```

**6. 数据加载**
```vue
<script setup lang="ts">
const onOpen = async (id = '') => {
  visible.value = true
  dataId.value = id

  if (id) {
    const { data } = await getEvaluationTemplate(+id)

    // 转换为编辑格式
    form.code = data.code
    form.name = data.name
    form.description = data.description
    form.status = data.status
    form.sort = data.sort
    form.remark = data.remark

    // 按大类分组评分项
    const categoryMap = new Map<string, Category>()
    data.items.forEach(item => {
      if (!categoryMap.has(item.categoryName)) {
        categoryMap.set(item.categoryName, {
          name: item.categoryName,
          sort: item.categorySort,
          items: [],
        })
      }
      categoryMap.get(item.categoryName)!.items.push({
        id: item.id,
        name: item.itemName,
        sort: item.itemSort,
        maxScore: item.maxScore,
        description: item.description,
      })
    })

    form.categories = Array.from(categoryMap.values()).sort((a, b) => a.sort - b.sort)
  }
}
</script>
```

**7. 数据保存**
```vue
<script setup lang="ts">
const save = async () => {
  // 校验总分
  if (totalScore.value !== 100) {
    Message.error('总分必须等于 100 分')
    return false
  }

  // 校验必填项
  const valid = await formRef.value?.validateForm()
  if (!valid) return false

  try {
    // 转换为保存格式
    const items: EvaluationTemplateItem[] = []
    form.categories.forEach(category => {
      category.items.forEach(item => {
        items.push({
          id: item.id,
          categoryName: category.name,
          categorySort: category.sort,
          itemName: item.name,
          itemSort: item.sort,
          maxScore: item.maxScore,
          description: item.description,
        })
      })
    })

    const data = {
      code: form.code,
      name: form.name,
      description: form.description,
      status: form.status,
      sort: form.sort,
      remark: form.remark,
      items,
    }

    if (isUpdate.value) {
      await updateEvaluationTemplate(data, +dataId.value)
      Message.success('修改成功')
    } else {
      await addEvaluationTemplate(data)
      Message.success('新增成功')
    }

    emit('save-success')
    return true
  } catch (error) {
    return false
  }
}
</script>
```

### 6.5 详情抽屉开发

**文件：** `views/config/evaluation-template/DetailDrawer.vue`

**核心要点：**
- 只读显示模板信息
- 按大类分组显示评分项
- 显示总分
- 不可编辑

**实现提示：**
- 复用编辑抽屉的布局
- 所有输入框改为只读
- 隐藏添加/删除按钮

---

## 七、测试验证阶段

### 7.1 单元测试（可选）

**后端单元测试：**

**文件：** `continew-admin/continew-system/src/test/java/top/continew/admin/system/service/EvaluationTemplateServiceTest.java`

**测试用例：**
1. 测试创建模板
2. 测试更新模板
3. 测试删除模板
4. 测试复制模板
5. 测试总分校验
6. 测试编码唯一性校验

### 7.2 功能测试

#### 测试用例 1：新增模板

**步骤：**
1. 登录系统
2. 进入【配置管理】>【评审模板管理】
3. 点击【新增】按钮
4. 填写基本信息
5. 添加评分大类
6. 添加评分项
7. 调整总分为 100
8. 点击【确定】保存

**预期结果：**
- 保存成功
- 列表显示新模板
- 统计字段正确（评分项数量、大类数量、总分）

#### 测试用例 2：修改模板

**步骤：**
1. 点击某个模板的【修改】按钮
2. 修改基本信息
3. 添加新评分项
4. 删除某个评分项
5. 修改某个评分项的分值
6. 调整总分为 100
7. 点击【确定】保存

**预期结果：**
- 保存成功
- 数据更新正确
- 统计字段重新计算

#### 测试用例 3：删除模板

**步骤：**
1. 点击某个模板的【删除】按钮
2. 确认删除

**预期结果：**
- 删除成功
- 列表不再显示该模板
- 数据库 `deleted` 字段被标记
- 评分项同时被逻辑删除

#### 测试用例 4：复制模板

**步骤：**
1. 点击某个模板的【复制】按钮
2. 自动打开编辑页
3. 修改模板编码和名称
4. 保存

**预期结果：**
- 复制成功
- 生成新模板
- 评分项完整复制
- 编码自动生成

#### 测试用例 5：总分校验

**步骤：**
1. 新增或修改模板
2. 设置总分不等于 100
3. 保存

**预期结果：**
- 前端提示"总分必须等于 100 分"
- 后端二次校验，返回错误

#### 测试用例 6：查看详情

**步骤：**
1. 点击某个模板的【详情】按钮
2. 查看模板信息和评分项

**预期结果：**
- 显示完整信息
- 按大类分组显示评分项
- 所有字段只读

### 7.3 性能测试

**测试场景：**
1. 列表分页查询（1000+ 条数据）
2. 复制包含大量评分项的模板
3. 批量删除模板

**性能指标：**
- 列表查询响应时间 < 500ms
- 创建/修改响应时间 < 1s
- 复制响应时间 < 2s

### 7.4 兼容性测试

**浏览器：**
- Chrome 最新版
- Edge 最新版
- Firefox 最新版
- Safari 最新版

**分辨率：**
- 1920x1080
- 1366x768
- 移动端响应式

---

## 八、部署上线阶段

### 8.1 代码审查

**检查项：**
1. 代码规范符合《开发标准规范.md》
2. 所有注释使用中文
3. 没有使用 emoji
4. Service 必须是接口
5. 使用 `@RequiredArgsConstructor` 注入依赖
6. 使用 `@Transactional` 保证事务
7. 前端使用 TypeScript 类型约束
8. API 调用统一使用封装方法

### 8.2 Git 提交

**提交规范：**

```bash
# 1. 数据库脚本提交
git add continew-admin/continew-server/src/main/resources/db/changelog/02-数据库脚本.sql
git commit -m "feat: 为评审模板表添加逻辑删除字段"

# 2. 后端代码提交
git add continew-admin/continew-system/src/main/java/top/continew/admin/system/
git commit -m "feat: 实现评审模板管理后端功能

- 新增评审模板主表和子表实体类
- 实现评审模板 CRUD 操作
- 支持主子表级联保存和删除
- 实现模板复制功能
- 添加总分校验逻辑"

# 3. 前端代码提交
git add continew-admin-ui/src/apis/config/
git add continew-admin-ui/src/views/config/evaluation-template/
git commit -m "feat: 实现评审模板管理前端功能

- 新增评审模板列表页
- 实现评审模板编辑功能
- 支持评分大类和评分项动态管理
- 实现总分实时计算和校验
- 添加模板复制功能"

# 4. 推送到远程
git push origin master
```

### 8.3 部署步骤

#### 步骤 1：后端部署

```bash
cd continew-admin
mvn clean package -DskipTests
```

#### 步骤 2：前端部署

```bash
cd continew-admin-ui
pnpm build
```

#### 步骤 3：启动服务

```bash
# 后端
java -jar continew-admin/continew-server/target/continew-server.jar

# 前端（Nginx 配置）
# 将 dist 目录内容部署到 Nginx
```

### 8.4 验收测试

**验收清单：**
- [ ] 菜单正常显示
- [ ] 权限控制正常
- [ ] 新增功能正常
- [ ] 修改功能正常
- [ ] 删除功能正常
- [ ] 复制功能正常
- [ ] 详情功能正常
- [ ] 总分校验正常
- [ ] 列表分页正常
- [ ] 搜索过滤正常
- [ ] 导出功能正常（如实现）

---

## 附录

### A. 关键技术点总结

1. **主子表级联操作**
   - 使用 `afterCreate` 钩子保存子表
   - 使用 `afterUpdate` 钩子更新子表（对比新增/修改/删除）
   - 使用 `beforeDelete` 钩子级联删除子表

2. **逻辑删除实现**
   - 实体类添加 `@TableLogic` 注解
   - 子表逻辑删除需手动实现

3. **总分校验**
   - 前端实时计算（`computed`）
   - 后端二次校验（`beforeCreate`、`beforeUpdate`）

4. **复制功能**
   - Service 层实现 `copyTemplate` 方法
   - 使用事务保证主子表同时复制
   - 自动生成新编码

### B. 常见问题

**Q1：逻辑删除后数据还能查到？**

A：检查实体类是否添加 `@TableLogic` 注解，MyBatis Plus 会自动过滤已删除数据。

**Q2：子表数据没有保存？**

A：检查 `afterCreate` 钩子是否添加 `@Transactional` 注解。

**Q3：总分计算不准确？**

A：检查前端是否使用 `BigDecimal` 或精确数值计算，避免浮点数精度问题。

**Q4：复制模板时编码重复？**

A：检查 `generateCode` 方法是否生成唯一编码。

### C. 优化建议

1. **性能优化**
   - 子表数据使用批量插入
   - 列表查询添加索引
   - 大量数据使用分页

2. **用户体验优化**
   - 添加加载状态
   - 添加操作确认
   - 添加操作成功提示

3. **功能扩展**
   - 支持模板导入导出
   - 支持模板预览
   - 支持模板启用/停用批量操作

---

**文档说明：**

本文档详细描述了评审模板管理功能的完整开发流程，从数据库准备到部署上线，每个阶段都有详细的步骤说明和代码示例。

开发时严格按照本文档执行，确保功能完整、代码规范、质量可控。
