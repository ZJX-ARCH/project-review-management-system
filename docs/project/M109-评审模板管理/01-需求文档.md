# M109 评审模板管理 - 需求文档

> 模块编号：M109
> 优先级：P0
> 创建时间：2025-12-20

---

## 一、功能概述

评审模板管理用于配置专家评审时的评分标准和评分项。每个项目类型关联一个评审模板，专家评审时按模板进行评分。

### 核心功能
1. 评审模板列表查询
2. 新建评审模板
3. 编辑评审模板
4. 复制评审模板
5. 启用/停用模板
6. 查看评分项详情

---

## 二、页面设计

### 2.1 列表页（evaluation-template-list.html）

#### 页面路径
- 前端路由：`/config/evaluation-template`
- 页面标题：评审模板管理

#### 搜索条件
| 字段 | 类型 | 说明 |
|-----|------|------|
| 模板名称 | 文本框 | 模糊搜索 |
| 状态 | 下拉框 | 全部/启用/停用 |

#### 列表字段
| 列名 | 字段 | 说明 |
|-----|------|------|
| 模板编码 | `code` | 唯一标识，如：TPL_001 |
| 模板名称 | `name` | 如：产品研发评审模板 |
| 评分项数量 | 计算字段 | 如：8项（5大类） |
| 总分 | `total_score` | 固定100分 |
| 关联项目类型 | 关联字段 | 显示项目类型名称 |
| 状态 | `status` | 启用/停用 |
| 操作 | - | 编辑/查看评分项/复制 |

#### 操作按钮
| 按钮 | 位置 | 权限 | 说明 |
|-----|------|------|------|
| 新建评审模板 | 搜索栏右侧 | `config:template:create` | 跳转到新建页 |
| 编辑 | 列表操作列 | `config:template:update` | 跳转到编辑页 |
| 查看评分项 | 列表操作列 | `config:template:get` | 弹窗显示评分项详情 |
| 复制 | 列表操作列 | `config:template:create` | 跳转到新建页，预填充数据 |

---

### 2.2 编辑页（evaluation-template-edit.html）

#### 页面路径
- 前端路由：`/config/evaluation-template/edit`
- 页面标题：
  - 新建：新建评审模板
  - 编辑：编辑评审模板
  - 复制：复制评审模板

#### 基本信息

| 字段 | 类型 | 必填 | 规则 | 说明 |
|-----|------|------|------|------|
| 模板编码 | 文本框 | 是 | 格式：TPL_XXX，最大20字符 | 创建后不可修改 |
| 模板名称 | 文本框 | 是 | 最大50字符 | - |
| 模板说明 | 文本域 | 否 | 最大500字符 | 描述适用场景、评审重点 |
| 状态 | 单选框 | 是 | 启用/停用 | 默认启用 |

#### 评分项配置

**数据结构**：
- 评分大类（Category）
  - 大类名称（如：一、技术创新性）
  - 包含多个评分项（Item）
  - 大类分数 = 所有评分项分数之和

- 评分项（Item）
  - 评分项名称（如：技术先进性）
  - 满分值（如：15分，支持小数 0.5）
  - 评分说明（评分标准、考察要点）

**功能要求**：
1. 支持动态添加/删除评分大类
2. 支持在大类下动态添加/删除评分项
3. 实时计算总分，显示在页面顶部
4. 总分必须等于100分才能保存
5. 总分颜色提示：
   - 绿色：等于100分
   - 红色：大于100分
   - 黄色：小于100分

**示例数据**（技术创新评审模板）：
```
一、技术创新性（25分）
  1. 技术先进性（15分）- 评价技术的前沿性和先进性
  2. 创新突破性（10分）- 评价是否有重大创新突破

二、技术可行性（25分）
  3. 技术方案合理性（15分）- 评价技术方案是否科学合理
  4. 实施团队能力（10分）- 评价团队技术实力

三、应用价值（30分）
  5. 应用前景（15分）- 评价技术应用潜力
  6. 预期效益（15分）- 评价预期产生的效益

四、预算合理性（10分）
  7. 预算编制合理性（10分）- 评价预算是否合理

五、风险控制（10分）
  8. 风险识别与应对（5分）- 评价风险控制措施
  9. 知识产权保护（3分）- 评价专利布局规划
  10. 技术保密措施（2分）- 评价技术保密方案
```

#### 提交验证
1. 模板编码不能为空，格式正确
2. 模板名称不能为空
3. 至少有1个评分大类
4. 每个大类至少有1个评分项
5. 总分必须等于100分
6. 每个评分项的名称和分值不能为空

---

## 三、数据库设计

### 3.1 评审模板主表（prj_evaluation_template）

| 字段 | 类型 | 长度 | 主键 | 非空 | 默认值 | 说明 |
|-----|------|------|------|------|--------|------|
| id | BIGINT | - | 是 | 是 | - | 主键ID |
| code | VARCHAR | 20 | - | 是 | - | 模板编码（唯一） |
| name | VARCHAR | 50 | - | 是 | - | 模板名称 |
| description | VARCHAR | 500 | - | 否 | NULL | 模板说明 |
| total_score | DECIMAL | 5,2 | - | 是 | 100.00 | 总分（固定100） |
| item_count | INT | - | - | 是 | 0 | 评分项数量 |
| category_count | INT | - | - | 是 | 0 | 评分大类数量 |
| status | TINYINT | - | - | 是 | 1 | 状态（1启用 2停用） |
| sort | INT | - | - | 是 | 0 | 排序 |
| remark | VARCHAR | 255 | - | 否 | NULL | 备注 |
| create_user | BIGINT | - | - | 是 | - | 创建人 |
| create_time | DATETIME | - | - | 是 | - | 创建时间 |
| update_user | BIGINT | - | - | 否 | NULL | 修改人 |
| update_time | DATETIME | - | - | 否 | NULL | 修改时间 |

**索引**：
- PRIMARY KEY (`id`)
- UNIQUE KEY `uk_code` (`code`)
- KEY `idx_status` (`status`)

---

### 3.2 评审模板评分项表（prj_evaluation_template_item）

| 字段 | 类型 | 长度 | 主键 | 非空 | 默认值 | 说明 |
|-----|------|------|------|------|--------|------|
| id | BIGINT | - | 是 | 是 | - | 主键ID |
| template_id | BIGINT | - | - | 是 | - | 模板ID |
| category_name | VARCHAR | 100 | - | 是 | - | 大类名称 |
| category_sort | INT | - | - | 是 | 0 | 大类排序 |
| item_name | VARCHAR | 100 | - | 是 | - | 评分项名称 |
| item_sort | INT | - | - | 是 | 0 | 评分项排序 |
| max_score | DECIMAL | 5,2 | - | 是 | - | 满分值 |
| description | VARCHAR | 500 | - | 否 | NULL | 评分说明 |
| create_user | BIGINT | - | - | 是 | - | 创建人 |
| create_time | DATETIME | - | - | 是 | - | 创建时间 |
| update_user | BIGINT | - | - | 否 | NULL | 修改人 |
| update_time | DATETIME | - | - | 否 | NULL | 修改时间 |

**索引**：
- PRIMARY KEY (`id`)
- KEY `idx_template_id` (`template_id`)
- KEY `idx_category_sort` (`template_id`, `category_sort`, `item_sort`)

---

## 四、API 接口设计

### 4.1 列表查询

**接口**：`GET /api/config/evaluation-template`

**请求参数**：
```json
{
  "name": "产品研发",  // 模板名称（模糊）
  "status": 1,         // 状态（1启用 2停用）
  "page": 1,
  "size": 10
}
```

**响应数据**：
```json
{
  "code": 200,
  "msg": "成功",
  "data": {
    "records": [
      {
        "id": 1,
        "code": "TPL_001",
        "name": "产品研发评审模板",
        "description": "适用于产品研发类项目评审...",
        "totalScore": 100.00,
        "itemCount": 8,
        "categoryCount": 5,
        "status": 1,
        "projectTypeName": "产品研发",
        "createTime": "2025-12-18 10:00:00"
      }
    ],
    "total": 5
  }
}
```

---

### 4.2 详情查询

**接口**：`GET /api/config/evaluation-template/{id}`

**响应数据**：
```json
{
  "code": 200,
  "msg": "成功",
  "data": {
    "id": 2,
    "code": "TPL_002",
    "name": "技术创新评审模板",
    "description": "适用于技术创新类项目评审...",
    "totalScore": 100.00,
    "status": 1,
    "items": [
      {
        "id": 1,
        "categoryName": "一、技术创新性",
        "categorySort": 1,
        "itemName": "技术先进性",
        "itemSort": 1,
        "maxScore": 15.00,
        "description": "评价技术的前沿性和先进性"
      },
      {
        "id": 2,
        "categoryName": "一、技术创新性",
        "categorySort": 1,
        "itemName": "创新突破性",
        "itemSort": 2,
        "maxScore": 10.00,
        "description": "评价是否有重大创新突破"
      }
      // ... 更多评分项
    ]
  }
}
```

---

### 4.3 新增

**接口**：`POST /api/config/evaluation-template`

**请求数据**：
```json
{
  "code": "TPL_006",
  "name": "新模板",
  "description": "模板说明",
  "status": 1,
  "items": [
    {
      "categoryName": "一、技术创新性",
      "categorySort": 1,
      "itemName": "技术先进性",
      "itemSort": 1,
      "maxScore": 15.00,
      "description": "评价技术的前沿性和先进性"
    }
    // ... 更多评分项
  ]
}
```

**响应数据**：
```json
{
  "code": 200,
  "msg": "创建成功",
  "data": 123
}
```

---

### 4.4 修改

**接口**：`PUT /api/config/evaluation-template/{id}`

**请求数据**：同新增接口（不含 code）

---

### 4.5 删除

**接口**：`DELETE /api/config/evaluation-template/{id}`

**业务规则**：
- 如果模板已被项目类型关联，不允许删除（软删除改为停用）

---

### 4.6 复制

**接口**：`POST /api/config/evaluation-template/{id}/copy`

**请求数据**：
```json
{
  "code": "TPL_007",
  "name": "复制的模板名称"
}
```

**响应数据**：
```json
{
  "code": 200,
  "msg": "复制成功",
  "data": 124
}
```

---

## 五、业务规则

### 5.1 模板编码规则
- 格式：`TPL_XXX`（XXX 为3位数字）
- 系统内唯一
- 创建后不可修改
- 建议按顺序编号：TPL_001、TPL_002...

### 5.2 总分规则
- 所有评审模板总分固定为100分
- 保存时必须验证总分是否等于100
- 总分 = 所有评分项的 max_score 之和

### 5.3 评分项规则
- 每个模板至少有1个评分大类
- 每个大类至少有1个评分项
- 评分项分值支持小数（精度0.5，如：15.5分）
- 评分项名称在同一模板内不能重复

### 5.4 模板状态
- 启用（status=1）：可被项目类型关联使用
- 停用（status=2）：不可被新项目类型关联，已关联的不受影响

### 5.5 关联规则
- 每个项目类型关联一个评审模板
- 模板被项目类型关联后，不允许删除（只能停用）
- 停用的模板不影响已有的评审任务

---

## 六、初始数据

系统预置5个评审模板：

| 编码 | 名称 | 评分项数量 | 关联类型 | 状态 |
|-----|------|----------|---------|------|
| TPL_001 | 产品研发评审模板 | 8项（5大类） | 产品研发 | 启用 |
| TPL_002 | 技术创新评审模板 | 10项（6大类） | 技术创新 | 启用 |
| TPL_003 | 流程优化评审模板 | 6项（4大类） | 流程优化 | 启用 |
| TPL_004 | 基础设施评审模板 | 7项（5大类） | 基础设施 | 启用 |
| TPL_005 | 市场拓展评审模板 | 9项（5大类） | 市场拓展 | 停用 |

详细评分项数据见 SQL 脚本。

---

## 七、权限设计

| 权限编码 | 权限名称 | 说明 |
|---------|---------|------|
| `config:template:list` | 列表查询 | 查看评审模板列表 |
| `config:template:get` | 详情查询 | 查看评审模板详情 |
| `config:template:create` | 新增 | 创建新模板 |
| `config:template:update` | 修改 | 编辑模板 |
| `config:template:delete` | 删除 | 删除模板 |

---

## 八、注意事项

1. **模板编辑影响范围**：
   - 修改模板不影响已完成的评审记录
   - 修改模板会影响进行中的评审任务
   - 建议：重大修改应创建新模板，旧模板停用

2. **性能优化**：
   - 评审模板数据不会很多，可全量缓存
   - 评分项查询建议使用索引

3. **前端交互**：
   - 评分项编辑采用动态表单
   - 实时计算总分并校验
   - 保存前校验总分是否等于100

4. **数据一致性**：
   - 删除模板时检查是否被项目类型关联
   - 修改模板时事务处理（主表+明细表）

---

*文档版本：V1.0*
*最后更新：2025-12-20*
